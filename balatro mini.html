<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BALATRO MINI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;700;900&display=swap');
        
        body {
            background-color: #050505;
            background-image: radial-gradient(circle at center, #1e1b4b 0%, #050505 100%);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 999;
            pointer-events: none;
            background-size: 100% 4px, 3px 100%;
        }

        .font-bungee { font-family: 'Bungee', cursive; }

        .card {
            aspect-ratio: 2/3;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s, opacity 0.2s;
            user-select: none;
            position: relative;
            touch-action: none;
        }

        .card.selected {
            transform: translateY(-10px) !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
            border: 4px solid #ffffff;
            z-index: 10;
        }

        .card:hover:not(.selected) {
            transform: translateY(-10px);
        }

        .card-debuffed {
            border: 4px dashed #ef4444 !important;
            opacity: 0.7;
            filter: grayscale(0.8);
        }

        .card-debuffed::after {
            content: "✕";
            position: absolute;
            font-size: 4rem;
            color: rgba(239, 68, 68, 0.8);
            font-weight: 900;
            pointer-events: none;
            z-index: 20;
        }

        /* Deck Viewer Specific Styling */
        .deck-card-mini {
            transition: transform 0.2s, z-index 0.2s;
            position: relative;
        }

        /* Only allow hover scaling on available cards */
        .deck-card-mini:not(.deck-card-spent):hover {
            transform: scale(1.8);
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8);
            border-color: #ffffff;
        }

        .deck-card-spent {
            opacity: 0.2;
            filter: grayscale(1);
            border-style: dotted;
            cursor: default;
        }

        .joker-slot, .powerup-slot {
            transition: all 0.2s;
        }
        
        .joker-slot.joker-selected {
            background-color: #fbbf24 !important;
            border-color: #ffffff !important;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.8);
            transform: scale(1.1);
        }

        @keyframes drawCard {
            0% { transform: translateY(300px) rotate(25deg); opacity: 0; }
            100% { transform: translateY(0) rotate(0); opacity: 1; }
        }

        .card-draw {
            animation: drawCard 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-animate {
            animation: slideUp 0.3s ease-out;
        }

        .rules-content::-webkit-scrollbar, .deck-content::-webkit-scrollbar {
            width: 8px;
        }
        .rules-content::-webkit-scrollbar-track, .deck-content::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .rules-content::-webkit-scrollbar-thumb, .deck-content::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .token-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .token-item:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.6);
        }

        .balatro-btn-blue {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border-bottom: 4px solid #1e3a8a;
        }
        .balatro-btn-red {
            background: linear-gradient(to bottom, #ef4444, #b91c1c);
            border-bottom: 4px solid #7f1d1d;
        }

        .boss-glow {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 select-none">

    <div id="game-container" class="w-full max-w-6xl flex flex-col h-[95vh] relative z-10 select-none">
        <!-- Header / Stats -->
        <div id="header-container" class="flex flex-wrap justify-between items-center bg-zinc-900/90 p-4 rounded-xl shadow-2xl mb-4 border-b-4 border-zinc-800 backdrop-blur-md transition-colors">
            <div class="flex flex-col">
                <div class="flex items-center gap-3">
                    <h1 class="font-bungee text-2xl text-white tracking-tighter italic">BALATRO <span class="text-orange-500">MINI</span></h1>
                    <button id="rules-btn" class="bg-zinc-700 hover:bg-zinc-600 text-[10px] font-bold px-2 py-1 rounded text-zinc-300 border border-zinc-500 transition uppercase tracking-tighter">Rules</button>
                    <button id="mute-btn" class="bg-zinc-700 hover:bg-zinc-600 p-1 rounded border border-zinc-500 transition">
                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    </button>
                </div>
                <div class="flex flex-col">
                    <p id="rank-display" class="text-xs uppercase font-black text-orange-400 tracking-widest">Rank: The Fish</p>
                    <p id="boss-display" class="text-[10px] uppercase font-bold text-red-500 tracking-widest hidden">BOSS: THE WALL</p>
                </div>
            </div>
            
            <div class="flex gap-4 sm:gap-8 items-center">
                <div class="text-center">
                    <p class="text-[10px] uppercase text-zinc-400 font-bold">Round</p>
                    <p id="round-num" class="text-xl font-bungee text-white">1</p>
                </div>
                <div class="text-center border-x border-zinc-700 px-4 sm:px-8">
                    <p class="text-[10px] uppercase text-zinc-400 font-bold">Goal</p>
                    <p id="round-target" class="text-xl font-bungee text-red-500">25</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] uppercase text-zinc-400 font-bold">Total Score</p>
                    <p id="round-score" class="text-2xl font-bungee text-emerald-400">0</p>
                </div>
            </div>

            <div class="flex gap-2 sm:gap-4 mt-2 sm:mt-0">
                <div class="bg-black/40 p-2 rounded text-center min-w-[70px] border border-zinc-700">
                    <p class="text-[10px] text-zinc-400 leading-none mb-1 uppercase font-bold">Hands</p>
                    <p id="plays-left" class="font-bungee text-blue-400 text-lg">3</p>
                </div>
                <div class="bg-black/40 p-2 rounded text-center min-w-[70px] border border-zinc-700">
                    <p class="text-[10px] text-zinc-400 leading-none mb-1 uppercase font-bold">Discards</p>
                    <p id="discards-left" class="font-bungee text-red-400 text-lg">3</p>
                </div>
            </div>
        </div>

        <!-- Main Play Area -->
        <div class="flex-grow flex flex-col justify-center gap-4 relative">
            
            <div class="absolute inset-x-0 top-0 flex justify-between items-start pointer-events-none z-20">
                <div id="joker-bank" class="flex flex-col gap-2 pointer-events-auto"></div>
                <div id="powerups-bank" class="flex flex-row gap-2 pointer-events-auto"></div>
            </div>

            <!-- Feedback -->
            <div id="hand-feedback" class="text-center min-h-[80px] flex flex-col items-center justify-center">
                <p id="status-message" class="text-2xl font-bungee text-white hidden mb-1 drop-shadow-lg"></p>
                <div class="flex flex-col items-center">
                    <p id="current-hand-type" class="text-3xl font-bungee text-orange-400 hidden drop-shadow-[0_0_10px_rgba(251,146,60,0.5)]"></p>
                    <p id="hand-level-display" class="text-[10px] font-black text-blue-400 hidden uppercase tracking-widest mt-1">Level 1</p>
                </div>
                <p id="current-hand-score" class="text-xl font-bold text-white hidden"></p>
            </div>

            <!-- Sort/View Controls -->
            <div class="flex flex-col items-center gap-2 mb-2">
                <div class="flex justify-center gap-2">
                    <button id="sort-rank-btn" class="bg-zinc-800 hover:bg-zinc-700 text-[10px] font-black uppercase tracking-widest px-4 py-1 rounded border border-zinc-600 transition">Sort Rank</button>
                    <button id="sort-suit-btn" class="bg-zinc-800 hover:bg-zinc-700 text-[10px] font-black uppercase tracking-widest px-4 py-1 rounded border border-zinc-600 transition">Sort Suit</button>
                    <button id="view-deck-btn" class="bg-zinc-800 hover:bg-zinc-700 text-[10px] font-black uppercase tracking-widest px-4 py-1 rounded border border-zinc-600 transition text-orange-400">View Deck</button>
                </div>
            </div>

            <!-- Hand -->
            <div id="hand-container" class="flex justify-center items-end gap-2 sm:gap-3 flex-wrap px-2 min-h-[180px] py-4"></div>

            <!-- Actions -->
            <div class="flex flex-col items-center gap-4 mt-4">
                <div id="selection-hint" class="text-zinc-500 text-xs font-bold uppercase tracking-widest h-4">Select up to 5 cards</div>
                <div class="flex justify-center gap-6">
                    <button id="discard-btn" class="balatro-btn-red hover:brightness-110 disabled:grayscale disabled:opacity-40 text-white font-bungee px-10 py-4 rounded-lg shadow-xl transform transition active:translate-y-1">
                        DISCARD
                    </button>
                    <button id="play-btn" class="balatro-btn-blue hover:brightness-110 disabled:grayscale disabled:opacity-40 text-white font-bungee px-14 py-4 rounded-lg shadow-xl transform transition active:translate-y-1">
                        PLAY HAND
                    </button>
                </div>
            </div>
        </div>

        <!-- Inventory -->
        <div class="mt-4 p-3 bg-zinc-900/80 rounded-xl flex items-center gap-4 border border-zinc-700 shadow-inner">
            <p class="text-xs font-bold text-zinc-500 uppercase italic">Inventory:</p>
            <div id="token-list" class="flex gap-2 flex-wrap"></div>
        </div>
    </div>

    <!-- Deck Overlay -->
    <div id="deck-overlay" class="fixed inset-0 bg-black/95 flex items-center justify-center hidden z-[150] p-4">
        <!-- Expanded max-width and internal spacing -->
        <div class="modal-animate bg-zinc-900 w-full max-w-5xl rounded-2xl overflow-hidden flex flex-col max-h-[90vh] border-4 border-orange-600 shadow-2xl">
            <div class="p-4 bg-orange-600 flex justify-between items-center">
                <h2 class="font-bungee text-xl text-white">DECK PROBABILITIES</h2>
                <div class="flex gap-4 items-center">
                    <span class="text-[10px] text-white font-bold italic uppercase opacity-80 hidden sm:inline">Dimmed cards are played/discarded</span>
                    <button id="close-deck" class="text-white hover:text-black font-bold text-2xl px-2">&times;</button>
                </div>
            </div>
            <!-- Standardized internal padding -->
            <div id="deck-view-content" class="deck-content p-8 overflow-y-auto space-y-8 flex flex-col justify-start">
                <!-- Rows will be injected here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="token-modal-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-[300] p-4 backdrop-blur-sm">
        <div class="modal-animate bg-zinc-900 w-full max-w-sm rounded-2xl p-8 border-4 border-orange-500 shadow-2xl text-center">
            <h2 id="token-modal-title" class="font-bungee text-2xl text-orange-400 mb-2">Use Token?</h2>
            <p id="token-modal-desc" class="text-zinc-300 text-sm mb-8 italic"></p>
            <div class="flex gap-4">
                <button id="token-modal-cancel" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white font-bungee py-3 rounded-lg border-b-4 border-zinc-950">Cancel</button>
                <button id="token-modal-confirm" class="flex-1 bg-orange-500 hover:bg-orange-400 text-black font-bungee py-3 rounded-lg border-b-4 border-orange-700">Use Now</button>
            </div>
        </div>
    </div>

    <div id="rules-overlay" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden z-[150] p-4">
        <div class="modal-animate bg-zinc-900 w-full max-w-2xl rounded-2xl overflow-hidden flex flex-col max-h-[90vh] border-4 border-blue-600 shadow-[0_0_50px_rgba(37,99,235,0.3)]">
            <div class="p-6 bg-blue-600 flex justify-between items-center">
                <h2 class="font-bungee text-2xl text-white">How to play BALATRO MINI</h2>
                <button id="close-rules" class="text-white hover:text-red-200 font-bold text-2xl">&times;</button>
            </div>
            <div class="rules-content p-8 overflow-y-auto space-y-6">
                <section>
                    <h3 class="font-bungee text-orange-400 text-xl mb-2 italic">Celestial Mechanics</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed">Upgrade your hand types in the Shoppe using Planet Cards to increase their base score forever. Every 4th level is a Boss Round with dangerous modifiers.</p>
                </section>
                <section>
                    <h3 class="font-bungee text-orange-400 text-xl mb-2 italic">Scoring Table</h3>
                    <div id="rules-scoring-list" class="grid grid-cols-2 gap-2 text-sm"></div>
                </section>
            </div>
        </div>
    </div>

    <div id="shop-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 p-4 backdrop-blur-md">
        <div class="modal-animate bg-zinc-900 w-full max-w-2xl rounded-2xl p-8 border-4 border-orange-500 shadow-[0_0_100px_rgba(249,115,22,0.3)]">
            <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
                <div>
                    <h2 class="font-bungee text-4xl text-white italic">THE <span class="text-orange-500">SHOPPE</span></h2>
                    <p class="text-zinc-400">Cash: <span id="excess-points-display" class="text-emerald-400 font-bold text-xl">$0</span></p>
                    <p id="hands-bonus-label" class="text-[10px] text-zinc-500 italic mt-1"></p>
                </div>
                <button id="next-round-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bungee px-8 py-3 rounded-lg border-b-4 border-emerald-800">NEXT ROUND</button>
            </div>
            <div id="shop-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <div id="game-over-overlay" class="fixed inset-0 bg-black/95 flex items-center justify-center hidden z-[200] p-4 text-center backdrop-blur-xl">
        <div class="max-w-md">
            <h2 class="font-bungee text-7xl text-red-600 mb-2 drop-shadow-[0_0_30px_rgba(220,38,38,0.5)]">GAME OVER</h2>
            <div class="bg-zinc-900 p-8 rounded-2xl mb-8 border border-zinc-800">
                <p class="text-zinc-400 uppercase font-bold text-sm tracking-widest mb-2 italic">Rounds Survived</p>
                <p id="final-rounds" class="text-6xl font-bungee text-white">0</p>
            </div>
            <button id="restart-game-btn" class="bg-white text-black font-bungee px-10 py-5 rounded-full text-2xl hover:bg-orange-500 transition transform hover:scale-105 active:scale-95 shadow-2xl">RESTART</button>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMuted = false;

        function playSound(type) {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            switch(type) {
                case 'draw':
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1); break;
                case 'select':
                    osc.type = 'square'; osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05); break;
                case 'play':
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2); break;
                case 'discard':
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15); break;
                case 'buy':
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, now);
                    osc.frequency.setValueAtTime(1320, now + 0.05);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2); break;
                case 'win':
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        o.frequency.setValueAtTime(freq, now + i * 0.1); g.gain.setValueAtTime(0.1, now + i * 0.1);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.2);
                        o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.2);
                    }); break;
                case 'lose':
                    [440, 349.23, 293.66].forEach((freq, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        o.frequency.setValueAtTime(freq, now + i * 0.15); g.gain.setValueAtTime(0.1, now + i * 0.15);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.3);
                        o.start(now + i * 0.15); o.stop(now + i * 0.15 + 0.3);
                    }); break;
            }
        }

        document.getElementById('mute-btn').onclick = () => {
            isMuted = !isMuted;
            const icon = document.getElementById('mute-icon');
            icon.innerHTML = isMuted 
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />';
        };

        // --- GAME LOGIC ---
        const SUITS = ['♠', '♥', '♣', '♦'];
        const VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const HAND_SCORES = {
            '5 of a Kind': 200, 'Royal Flush': 150, 'Straight Flush': 125, 'Four of a Kind': 100,
            'Full House': 60, 'Flush': 50, 'Straight': 40, 'Three of a Kind': 30, 'Two Pair': 20, 'Pair': 10, 'High Card': 5
        };
        const JOKER_ICON = `<span class="text-7xl leading-none select-none drop-shadow-lg">♛</span>`;
        const SHIELD_SVG = `<svg viewBox="0 0 24 24" class="w-10 h-10" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>`;
        const HAND_SVG = `<svg viewBox="0 0 24 24" class="w-10 h-10" fill="currentColor"><path d="M21 4.5V11c0 1.93-1.57 3.5-3.5 3.5H17l-3.3 3.3c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41L15.59 13H11v4c0 .55-.45 1-1 1s-1-.45-1-1V9c0-.55.45-1 1-1s1 .45 1 1v2h1.59l-1.3-1.3c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L17 11.59V4.5C17 3.67 16.33 3 15.5 3S14 3.67 14 4.5v6c0 .55-.45 1-1 1s-1-.45-1-1V3.5c0-.83-.67-1.5-1.5-1.5S9 2.67 9 3.5v7c0 .55-.45 1-1 1s-1-.45-1-1V5.5C7 4.67 6.33 4 5.5 4S4 4.67 4 5.5V17c0 3.87 3.13 7 7 7 3.87 0 7-3.13 7-7v-3.5c1.93 0 3.5-1.57 3.5-3.5V4.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5z"/></svg>`;

        const SHOP_ITEMS = [
            { id: 'extra_discard', name: 'Extra Discard', cost: 25, desc: 'Adds +1 Discard immediately' },
            { id: 'extra_discard_perm', name: 'Waste Not', cost: 75, desc: 'Adds +1 Discard permanently' },
            { id: 'extra_card_perm', name: 'Expanded Grip', cost: 125, desc: 'Adds +1 Hand Limit permanently' },
            { id: 'pocket_points', name: 'Pocket Points', cost: 50, desc: 'Adds +25 to total round score' },
            { id: 'extra_hand', name: 'Extra Hand', cost: 100, desc: 'Adds +1 Play permanently (1/game)' },
            { id: 'double_score', name: 'Double Score', cost: 100, desc: 'Next play gains double points' },
            { id: 'shield', name: 'Shield', cost: 150, desc: 'Automatic protection from Game Over' }
        ];

        const BOSSES = [
            { id: 'the_wall', name: 'THE WALL', desc: 'Target score is doubled.', effect: (state) => { state.target *= 2; } },
            { id: 'the_needle', name: 'THE NEEDLE', desc: 'Only 1 hand play allowed.', effect: (state) => { state.plays = 1; } },
            { id: 'the_flint', name: 'THE FLINT', desc: 'Hearts score 0.', effect: (state) => { state.debuffSuits = ['♥']; } },
            { id: 'the_club', name: 'THE CLUB', desc: 'Clubs score 0.', effect: (state) => { state.debuffSuits = ['♣']; } },
            { id: 'the_spade', name: 'THE SPADE', desc: 'Spades score 0.', effect: (state) => { state.debuffSuits = ['♠']; } },
            { id: 'the_diamond', name: 'THE DIAMOND', desc: 'Diamonds score 0.', effect: (state) => { state.debuffSuits = ['♦']; } },
            { id: 'the_hook', name: 'THE HOOK', desc: 'No discards allowed.', effect: (state) => { state.discards = 0; } }
        ];

        let state = {
            round: 1, target: 25, score: 0, excessPoints: 0,
            plays: 3, discards: 3, handLimit: 8, basePlays: 3, baseDiscards: 3, baseHandLimit: 8,
            deck: [], hand: [], selectedIndices: [], bankedJokers: 0, jokerSelected: false,
            inventory: [], isShopOpen: false, currentSortMethod: 'none',
            drawBatchId: 0, doubleNextPlay: false, shieldActive: false,
            permanentPowerupsBought: [],
            // Celestial System
            handLevels: Object.fromEntries(Object.keys(HAND_SCORES).map(k => [k, 1])),
            // Boss System
            currentBoss: null,
            debuffSuits: [],
            bossesDefeated: 0,
            // Interaction
            isSwipeSelecting: false,
            swipeMode: null,
            swipeTouchedIndices: new Set(),
            // Shop state persistence
            currentShopOffers: []
        };

        const RANK_TIERS = ["The Fish", "The Rounder", "High Roller", "The Shark", "The Legend", "The Myth", "Card Counter", "Vegas King"];

        function getRank(bossesDefeated) {
            return RANK_TIERS[Math.min(bossesDefeated, RANK_TIERS.length - 1)];
        }

        function initDeck() {
            let deck = [];
            SUITS.forEach(suit => VALUES.forEach(val => deck.push({ suit, val, isJoker: false })));
            deck.push({ suit: '?', val: 'Joker', isJoker: true }); 
            return shuffle(deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]];
            } return array;
        }

        function startRound() {
            state.target = state.round * 25;
            state.score = 0;
            state.plays = state.basePlays;
            state.discards = state.baseDiscards;
            state.handLimit = state.baseHandLimit;
            state.debuffSuits = [];
            state.currentBoss = null;
            state.doubleNextPlay = false;
            state.deck = initDeck();
            state.hand = [];
            state.jokerSelected = false;
            state.selectedIndices = [];
            state.drawBatchId++;

            const header = document.getElementById('header-container');
            const bossDisplay = document.getElementById('boss-display');
            header.className = "flex flex-wrap justify-between items-center bg-zinc-900/90 p-4 rounded-xl shadow-2xl mb-4 border-b-4 border-zinc-800 backdrop-blur-md transition-all";
            bossDisplay.classList.add('hidden');

            if (state.round % 4 === 0) {
                state.currentBoss = BOSSES[Math.floor(Math.random() * BOSSES.length)];
                state.currentBoss.effect(state);
                bossDisplay.textContent = `BOSS: ${state.currentBoss.name} - ${state.currentBoss.desc}`;
                bossDisplay.classList.remove('hidden');
                header.classList.add('border-red-600', 'bg-red-950/20', 'boss-glow');
                showMessage("BOSS ROUND!", "text-red-500 font-black scale-125");
            }

            drawToFull();
        }

        function applyCurrentSort() {
            if (state.currentSortMethod === 'rank') {
                state.hand.sort((a, b) => VALUES.indexOf(b.val) - VALUES.indexOf(a.val));
            } else if (state.currentSortMethod === 'suit') {
                state.hand.sort((a, b) => {
                    if (a.suit === b.suit) return VALUES.indexOf(b.val) - VALUES.indexOf(a.val);
                    return SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit);
                });
            }
        }

        function drawToFull() {
            let currentBatch = state.drawBatchId; let cardsDrawn = 0;
            while (state.hand.length < state.handLimit && state.deck.length > 0) {
                let card = state.deck.pop();
                if (card.isJoker) {
                    if (state.bankedJokers > 0) {
                        state.bankedJokers = 0; showMessage("DUPLICATE JOKER!", "text-red-500"); playSound('discard');
                    } else {
                        state.bankedJokers = 1; showMessage("JOKER FOUND!", "text-yellow-400 font-bold"); playSound('buy');
                    } continue; 
                }
                card.batchId = currentBatch; state.hand.push(card); cardsDrawn++;
            }
            if (cardsDrawn > 0) playSound('draw');
            if (state.currentSortMethod !== 'none') applyCurrentSort();
            render();
        }

        function sortHand(type) {
            playSound('select'); state.currentSortMethod = type; applyCurrentSort(); state.selectedIndices = []; render();
        }

        function evaluateHand(selectedCards, useWild) {
            const totalCards = selectedCards.length + (useWild ? 1 : 0); if (totalCards === 0) return null;
            const values = selectedCards.map(c => c.val); const suits = selectedCards.map(c => c.suit);
            const valCounts = {}; values.forEach(v => valCounts[v] = (valCounts[v] || 0) + 1);
            let counts = Object.values(valCounts).sort((a,b) => b-a);
            if (useWild) { if (counts.length === 0) counts = [1]; else counts[0] += 1; }
            if (counts[0] >= 5) return '5 of a Kind';
            const isFlush = new Set(suits).size === 1 && totalCards === 5;
            const valIndices = values.map(v => VALUES.indexOf(v)).sort((a,b) => a-b);
            let isStraight = false;
            
            const wheelIndices = [0, 1, 2, 3, 12]; 
            if (totalCards === 5) {
                let uv = new Set(valIndices);
                if (!useWild) {
                    if (uv.size === 5) {
                        if (valIndices[4] - valIndices[0] === 4) isStraight = true;
                        if (valIndices.every((v, i) => v === wheelIndices[i])) isStraight = true;
                    }
                } else {
                    if (uv.size === 4) {
                        if (valIndices[3] - valIndices[0] <= 4) isStraight = true;
                        if ([...uv].every(v => wheelIndices.includes(v))) isStraight = true;
                    }
                }
            }
            
            if (isFlush && isStraight) {
                if ((values.includes('A') && (values.includes('K') || useWild)) || (isStraight && values.includes('A') && values.includes('5'))) {
                    if (values.includes('K') || (useWild && values.includes('Q'))) return 'Royal Flush';
                }
                return 'Straight Flush';
            }
            if (counts[0] >= 4) return 'Four of a Kind';
            if (counts[0] === 3 && counts[1] === 2) return 'Full House';
            if (isFlush) return 'Flush';
            if (isStraight) return 'Straight';
            if (counts[0] === 3) return 'Three of a Kind';
            if (counts[0] === 2 && counts[1] === 2) return 'Two Pair';
            if (counts[0] === 2) return 'Pair';
            return 'High Card';
        }

        function playHand() {
            const totalSelected = state.selectedIndices.length + (state.jokerSelected ? 1 : 0);
            if (totalSelected === 0) return;
            if (state.plays <= 0) return;
            
            playSound('play'); 
            let selected = state.selectedIndices.map(i => state.hand[i]);
            let handType = evaluateHand(selected, state.jokerSelected);
            
            let isDebuffed = selected.some(c => state.debuffSuits.includes(c.suit));
            
            let baseVal = (handType === 'Royal Flush' && state.jokerSelected) ? 250 : (HAND_SCORES[handType] || 5);
            let level = state.handLevels[handType] || 1;
            
            let handBaseScore = isDebuffed ? 0 : Math.round(baseVal * (1 + (level - 1) * 0.5));
            
            if (state.doubleNextPlay) { handBaseScore *= 2; state.doubleNextPlay = false; }
            
            state.score += handBaseScore; 
            state.plays--;
            
            if (isDebuffed) showMessage("DEBUFFED!", "text-red-400 font-bold");
            
            if (state.jokerSelected) { state.bankedJokers = 0; state.jokerSelected = false; }
            state.hand = state.hand.filter((_, i) => !state.selectedIndices.includes(i));
            state.selectedIndices = []; 
            state.drawBatchId++; 
            drawToFull(); 
            checkRoundStatus();
        }

        function discardCards() {
            if (state.selectedIndices.length === 0 || state.discards <= 0) return;
            playSound('discard'); state.hand = state.hand.filter((_, i) => !state.selectedIndices.includes(i));
            state.selectedIndices = []; state.discards--; state.drawBatchId++; drawToFull();
        }

        function checkRoundStatus() {
            if (state.score >= state.target) { 
                playSound('win'); 
                if (state.round % 4 === 0) state.bossesDefeated++;
                endRound(); 
            } 
            else if (state.plays <= 0) {
                if (state.shieldActive) {
                    state.shieldActive = false; showMessage("SHIELD USED!", "text-blue-400"); playSound('buy'); endRound();
                } else { playSound('lose'); gameOver(); }
            }
        }

        function endRound() { 
            const handsBonus = state.plays * 10;
            state.excessPoints = Math.max(0, state.score - state.target) + handsBonus; 
            
            state.isShopOpen = true; 
            document.getElementById('shop-overlay').classList.remove('hidden');
            document.getElementById('excess-points-display').textContent = "$" + state.excessPoints; 
            document.getElementById('hands-bonus-label').textContent = `Efficiency Bonus: +$${handsBonus} (${state.plays} Hands Remaining)`;
            
            openShop(true); 
        }

        function gameOver() {
            document.getElementById('final-rounds').textContent = state.round - 1;
            document.getElementById('game-over-overlay').classList.remove('hidden');
        }

        function resetGame() {
            playSound('select');
            Object.assign(state, { 
                round: 1, score: 0, excessPoints: 0, basePlays: 3, baseDiscards: 3, baseHandLimit: 8, bankedJokers: 0, 
                inventory: [], shieldActive: false, currentSortMethod: 'none', 
                drawBatchId: 0, permanentPowerupsBought: [],
                handLevels: Object.fromEntries(Object.keys(HAND_SCORES).map(k => [k, 1])),
                debuffSuits: [], currentBoss: null, bossesDefeated: 0
            });
            document.getElementById('game-over-overlay').classList.add('hidden');
            startRound();
        }

        function openShop(initPool = false) {
            if (initPool) {
                state.currentShopOffers = [];
                
                // Filter SHOP_ITEMS to only those not currently acquired
                const availableItems = SHOP_ITEMS.filter(item => {
                    const isPermanent = item.id === 'extra_hand' || item.id === 'extra_discard_perm' || item.id === 'extra_card_perm';
                    const alreadyBoughtPermanent = isPermanent && state.permanentPowerupsBought.includes(item.id);
                    const ownedInInventory = !isPermanent && item.id !== 'shield' && state.inventory.some(i => i.id === item.id);
                    const shieldActive = item.id === 'shield' && state.shieldActive;
                    return !alreadyBoughtPermanent && !ownedInInventory && !shieldActive;
                });

                const shuffledStandard = availableItems.sort(() => Math.random() - 0.5);
                shuffledStandard.slice(0, 4).forEach(item => state.currentShopOffers.push({ type: 'token', data: item, purchased: false }));
                
                // Hand types can always be upgraded
                const availableHands = Object.keys(HAND_SCORES).sort(() => Math.random() - 0.5).slice(0, 2);
                availableHands.forEach(hand => state.currentShopOffers.push({ type: 'celestial', data: hand, purchased: false }));
            }
            renderShop();
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            
            state.currentShopOffers.forEach((offer, idx) => {
                const btn = document.createElement('div');
                const owned = offer.purchased;

                if (offer.type === 'token') {
                    const item = offer.data;
                    const canAfford = state.excessPoints >= item.cost;

                    btn.className = `p-4 rounded-2xl border-2 transition flex flex-col justify-between h-32 ${owned ? 'bg-zinc-800 border-zinc-700 opacity-50 cursor-not-allowed' : (canAfford ? 'bg-black border-zinc-700 hover:border-orange-500 cursor-pointer' : 'bg-black border-red-900/50 opacity-60 cursor-not-allowed')}`;
                    btn.innerHTML = `<div class="flex justify-between items-start"><span class="font-bungee text-sm text-white uppercase italic leading-tight">${item.name}</span><span class="font-bungee text-sm ${canAfford ? 'text-emerald-400' : 'text-red-500'}">$${item.cost}</span></div><p class="text-[10px] text-zinc-400 font-medium mt-1">${item.desc}</p>${owned ? '<p class="text-[8px] text-orange-500 font-black uppercase mt-1">Acquired</p>' : ''}`;
                    if (!owned && canAfford) btn.onclick = () => buyItem(item, idx);
                } else {
                    const handType = offer.data;
                    const level = state.handLevels[handType];
                    const cost = 10 + (level * 5);
                    const canAfford = state.excessPoints >= cost && !owned;

                    btn.className = `p-4 rounded-2xl border-2 transition flex flex-col justify-between h-32 ${owned ? 'bg-zinc-800 border-zinc-700 opacity-50 cursor-not-allowed' : (canAfford ? 'bg-black border-blue-900/50 hover:border-blue-400 cursor-pointer' : 'bg-black border-red-900/20 opacity-60 cursor-not-allowed')}`;
                    btn.innerHTML = `<div class="flex justify-between items-start"><span class="font-bungee text-sm text-blue-300 uppercase italic leading-tight">${handType}</span><span class="font-bungee text-sm ${canAfford ? 'text-emerald-400' : 'text-red-500'}">$${cost}</span></div><p class="text-[10px] text-zinc-400 mt-1">Lv. ${level} ➔ ${level+1}. Increases score.</p>${owned ? '<p class="text-[8px] text-blue-400 font-black uppercase mt-1">Upgraded</p>' : ''}`;
                    if (!owned && canAfford) btn.onclick = () => upgradeHand(handType, cost, idx);
                }

                grid.appendChild(btn);
            });
        }

        function upgradeHand(handType, cost, offerIdx) {
            if (state.excessPoints >= cost) {
                playSound('buy');
                state.excessPoints -= cost;
                state.handLevels[handType]++;
                state.currentShopOffers[offerIdx].purchased = true;
                document.getElementById('excess-points-display').textContent = "$" + state.excessPoints;
                renderShop();
            }
        }

        function buyItem(item, offerIdx) {
            if (state.excessPoints >= item.cost) {
                playSound('buy'); state.excessPoints -= item.cost;
                state.currentShopOffers[offerIdx].purchased = true;
                if (item.id === 'extra_hand') {
                    state.basePlays++; state.plays++; state.permanentPowerupsBought.push(item.id);
                } else if (item.id === 'extra_discard_perm') {
                    state.baseDiscards++; state.discards++; state.permanentPowerupsBought.push(item.id);
                } else if (item.id === 'extra_card_perm') {
                    state.baseHandLimit++; state.handLimit++; state.permanentPowerupsBought.push(item.id);
                } else if (item.id === 'shield') {
                    state.shieldActive = true;
                } else {
                    state.inventory.push({...item});
                }
                document.getElementById('excess-points-display').textContent = "$" + state.excessPoints;
                renderShop(); render();
            }
        }

        function activateToken(index) {
            playSound('play'); const item = state.inventory.splice(index, 1)[0];
            switch(item.id) {
                case 'extra_discard': state.discards++; break;
                case 'pocket_points': state.score += 25; break;
                case 'double_score': state.doubleNextPlay = true; break;
            }
            render();
        }

        function showTokenModal(index) {
            playSound('select'); state.currentTokenToUse = index;
            const item = state.inventory[index];
            document.getElementById('token-modal-title').textContent = `USE ${item.name.toUpperCase()}?`;
            document.getElementById('token-modal-desc').textContent = item.desc;
            document.getElementById('token-modal-overlay').classList.remove('hidden');
        }

        document.getElementById('token-modal-confirm').onclick = () => {
            if (state.currentTokenToUse !== null) activateToken(state.currentTokenToUse);
            document.getElementById('token-modal-overlay').classList.add('hidden');
        };
        document.getElementById('token-modal-cancel').onclick = () => document.getElementById('token-modal-overlay').classList.add('hidden');

        function showMessage(msg, colorClass) {
            const el = document.getElementById('status-message'); el.innerHTML = msg;
            el.className = `text-2xl font-bungee ${colorClass} mb-1 drop-shadow-lg`; el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // --- DECK VIEWER LOGIC ---
        function showDeck() {
            playSound('select');
            const content = document.getElementById('deck-view-content');
            content.innerHTML = '';
            
            const displayValues = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

            SUITS.forEach(suit => {
                const suitRow = document.createElement('div');
                suitRow.className = "flex gap-8 items-center w-full justify-center";
                
                // LEFT INDICATOR (Suit Icon)
                const leftIndicator = document.createElement('div');
                leftIndicator.className = `w-14 h-16 flex items-center justify-center font-bungee text-3xl bg-zinc-800 rounded-lg shrink-0 ${suit === '♥' || suit === '♦' ? 'text-red-500' : 'text-zinc-400'}`;
                leftIndicator.textContent = suit;
                suitRow.appendChild(leftIndicator);

                const cardContainer = document.createElement('div');
                cardContainer.className = "flex gap-3 justify-center";

                let suitCount = 0;

                displayValues.forEach(val => {
                    const inDeck = state.deck.some(c => c.suit === suit && c.val === val);
                    const inHand = state.hand.some(c => c.suit === suit && c.val === val);
                    const isAvailable = inDeck || inHand;

                    if (isAvailable) suitCount++;

                    const isRed = suit === '♥' || suit === '♦';
                    const el = document.createElement('div');
                    el.className = `deck-card-mini w-12 h-16 bg-white rounded-lg border-2 flex flex-col items-center justify-center shadow-md transition-all ${isRed ? 'text-red-600' : 'text-zinc-900'} ${isAvailable ? 'border-zinc-300' : 'deck-card-spent border-transparent'}`;
                    
                    el.innerHTML = `
                        <span class="text-sm font-black leading-none">${val}</span>
                        <span class="text-lg leading-none mt-1">${suit}</span>
                    `;
                    cardContainer.appendChild(el);
                });

                suitRow.appendChild(cardContainer);

                // RIGHT INDICATOR (Count)
                const rightIndicator = document.createElement('div');
                rightIndicator.className = `w-14 h-16 flex items-center justify-center font-bungee text-2xl bg-zinc-800 rounded-lg shrink-0 ${suit === '♥' || suit === '♦' ? 'text-red-500' : 'text-zinc-400'}`;
                rightIndicator.textContent = suitCount;
                suitRow.appendChild(rightIndicator);

                content.appendChild(suitRow);
            });

            document.getElementById('deck-overlay').classList.remove('hidden');
        }

        // --- INTERACTION LOGIC ---
        function handleInteractionStart(e, index = null) {
            if (e.cancelable) e.preventDefault();
            state.isSwipeSelecting = true;
            state.swipeTouchedIndices.clear();
            if (index !== null) {
                const isAlreadySelected = state.selectedIndices.includes(index);
                state.swipeMode = isAlreadySelected ? 'deselect' : 'select';
                toggleCardSelection(index, state.swipeMode);
                state.swipeTouchedIndices.add(index);
            } else { state.swipeMode = 'select'; }
        }

        function handleInteractionMove(e) {
            if (!state.isSwipeSelecting) return;
            let clientX, clientY;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
            } else { clientX = e.clientX; clientY = e.clientY; }
            const target = document.elementFromPoint(clientX, clientY);
            const cardEl = target?.closest('[data-card-index]');
            if (cardEl) {
                const index = parseInt(cardEl.getAttribute('data-card-index'));
                if (!state.swipeTouchedIndices.has(index)) {
                    toggleCardSelection(index, state.swipeMode);
                    state.swipeTouchedIndices.add(index);
                }
            }
        }

        function stopInteraction() {
            state.isSwipeSelecting = false;
            state.swipeTouchedIndices.clear();
        }

        function toggleCardSelection(index, mode) {
            const pos = state.selectedIndices.indexOf(index);
            const totalSelected = state.selectedIndices.length + (state.jokerSelected ? 1 : 0);
            
            if (mode === 'select') {
                if (pos === -1 && totalSelected < 5) {
                    playSound('select'); state.selectedIndices.push(index);
                }
            } else if (mode === 'deselect') {
                if (pos > -1) {
                    playSound('select'); state.selectedIndices.splice(pos, 1);
                }
            }
            render();
        }

        window.addEventListener('mouseup', stopInteraction);
        window.addEventListener('touchend', stopInteraction);
        window.addEventListener('mousemove', handleInteractionMove);
        window.addEventListener('touchmove', handleInteractionMove, { passive: false });
        window.addEventListener('selectstart', (e) => e.preventDefault());

        function render() {
            document.getElementById('round-num').textContent = state.round;
            document.getElementById('round-target').textContent = state.target;
            document.getElementById('round-score').textContent = state.score;
            document.getElementById('plays-left').textContent = state.plays;
            document.getElementById('discards-left').textContent = state.discards;
            document.getElementById('rank-display').textContent = `Rank: ${getRank(state.bossesDefeated)}`;

            let sel = state.selectedIndices.map(idx => state.hand[idx]);
            let prospective = evaluateHand(sel, state.jokerSelected);
            const fh = document.getElementById('current-hand-type'); 
            const fs = document.getElementById('current-hand-score');
            const fl = document.getElementById('hand-level-display');
            
            if (prospective) {
                const isLegendary = (prospective === 'Royal Flush' && state.jokerSelected) || prospective === '5 of a Kind';
                const baseVal = (prospective === 'Royal Flush' && state.jokerSelected) ? 250 : (HAND_SCORES[prospective] || 5);
                const level = state.handLevels[prospective] || 1;
                let score = Math.round(baseVal * (1 + (level - 1) * 0.5));
                if (state.doubleNextPlay) score *= 2;
                
                fh.textContent = (prospective === 'Royal Flush' && state.jokerSelected) ? 'WILD ROYAL FLUSH' : prospective.toUpperCase();
                fh.className = `text-3xl font-bungee ${isLegendary ? 'text-orange-400 drop-shadow-[0_0_15px_rgba(251,146,60,0.8)]' : 'text-white'} drop-shadow-lg`;
                fh.classList.remove('hidden'); 
                
                fl.textContent = `Level ${level}`;
                fl.classList.remove('hidden');

                fs.textContent = `+${score} Points`; 
                fs.classList.remove('hidden');
            } else { 
                fh.classList.add('hidden'); 
                fs.classList.add('hidden'); 
                fl.classList.add('hidden');
            }

            const hc = document.getElementById('hand-container'); hc.innerHTML = ''; let dc = 0;
            state.hand.forEach((card, i) => {
                const s = state.selectedIndices.includes(i); const isRed = card.suit === '♥' || card.suit === '♦';
                const n = card.batchId === state.drawBatchId; 
                const isDebuffed = state.debuffSuits.includes(card.suit);
                
                const el = document.createElement('div'); 
                el.className = `card w-20 sm:w-28 bg-white rounded-xl flex flex-col items-center justify-center shadow-2xl border-4 ${s ? 'selected' : 'border-zinc-300'} ${isRed ? 'text-red-600' : 'text-zinc-900'} ${n ? 'card-draw' : ''} ${isDebuffed ? 'card-debuffed' : ''}`;
                el.setAttribute('data-card-index', i);
                if (n) el.style.animationDelay = `${dc++ * 0.1}s`;
                el.innerHTML = `<div class="absolute top-2 left-2 flex flex-col items-center pointer-events-none"><span class="text-base sm:text-lg font-black leading-none">${card.val}</span><span class="text-xs sm:text-sm font-bold leading-none">${card.suit}</span></div><div class="text-4xl sm:text-5xl font-black pointer-events-none">${card.suit}</div>`;
                
                el.addEventListener('mousedown', (e) => { e.stopPropagation(); handleInteractionStart(e, i); });
                el.addEventListener('touchstart', (e) => { e.stopPropagation(); handleInteractionStart(e, i); });
                hc.appendChild(el);
            });

            hc.onmousedown = (e) => handleInteractionStart(e);
            hc.ontouchstart = (e) => handleInteractionStart(e);

            state.hand.forEach(c => c.batchId = -1);

            const jb = document.getElementById('joker-bank'); jb.innerHTML = '';
            if (state.bankedJokers > 0) {
                const j = document.createElement('div'); j.className = `joker-slot w-20 h-28 rounded-xl flex flex-col items-center justify-center border-4 ${state.jokerSelected ? 'joker-selected' : 'bg-white border-zinc-300'} text-zinc-900 shadow-xl cursor-pointer`;
                j.innerHTML = `<div class="flex items-center justify-center w-full h-14 overflow-hidden pointer-events-none">${JOKER_ICON}</div><span class="text-[10px] font-bold uppercase pointer-events-none">${state.jokerSelected ? 'SELECTED' : 'WILD'}</span>`;
                j.onclick = (e) => { 
                    e.stopPropagation(); 
                    const totalSelected = state.selectedIndices.length + (state.jokerSelected ? 1 : 0);
                    if (!state.jokerSelected && totalSelected >= 5) return; 
                    playSound('select'); 
                    state.jokerSelected = !state.jokerSelected; 
                    render(); 
                }; 
                jb.appendChild(j);
            }

            const pb = document.getElementById('powerups-bank'); pb.innerHTML = '';
            if (state.shieldActive) {
                const s = document.createElement('div'); s.className = `w-20 h-28 bg-cyan-900/30 border-4 border-cyan-500 rounded-xl flex flex-col items-center justify-center text-cyan-400 shadow-xl backdrop-blur-sm`;
                s.innerHTML = `${SHIELD_SVG} <span class="text-[10px] font-bold uppercase mt-1">SHIELDED</span>`; pb.appendChild(s);
            }
            if (state.basePlays > 3) {
                const h = document.createElement('div'); h.className = `w-20 h-28 bg-blue-900/30 border-4 border-blue-500 rounded-xl flex flex-col items-center justify-center text-blue-400 shadow-xl backdrop-blur-sm`;
                h.innerHTML = `${HAND_SVG} <span class="text-[10px] font-bold uppercase mt-1">+${state.basePlays-3} HANDS</span>`; pb.appendChild(h);
            }

            const tl = document.getElementById('token-list'); tl.innerHTML = '';
            state.inventory.forEach((it, idx) => {
                const t = document.createElement('div'); t.className = 'token-item px-3 py-1 bg-zinc-800 text-[10px] rounded border-2 border-orange-600 text-orange-500 font-black uppercase tracking-widest italic';
                t.textContent = it.name; t.onclick = (e) => { e.stopPropagation(); showTokenModal(idx); }; tl.appendChild(t);
            });

            const rl = document.getElementById('rules-scoring-list');
            if (rl.children.length === 0) {
                Object.entries(HAND_SCORES).sort((a,b) => b[1]-a[1]).forEach(([name, val]) => {
                    const row = document.createElement('div');
                    row.className = 'bg-black/40 p-2 flex justify-between border border-zinc-800';
                    row.innerHTML = `<span class="capitalize text-zinc-400">${name}</span><span id="score-lv-${name.replace(/\s/g, '-')}" class="font-bold text-white">${val}</span>`;
                    rl.appendChild(row);
                });
            } else {
                Object.entries(HAND_SCORES).forEach(([name, val]) => {
                    const level = state.handLevels[name];
                    const scaled = Math.round(val * (1 + (level - 1) * 0.5));
                    const el = document.getElementById(`score-lv-${name.replace(/\s/g, '-')}`);
                    if (el) el.innerHTML = `${scaled} <small class="text-blue-500 text-[8px]">LV${level}</small>`;
                });
            }

            const currentTotalSelected = state.selectedIndices.length + (state.jokerSelected ? 1 : 0);
            document.getElementById('discard-btn').disabled = state.discards <= 0 || state.selectedIndices.length === 0;
            document.getElementById('play-btn').disabled = state.plays <= 0 || currentTotalSelected === 0;
            document.getElementById('selection-hint').textContent = currentTotalSelected > 0 ? `${currentTotalSelected} / 5 CARDS SELECTED` : "SELECT UP TO 5 CARDS";
        }

        document.getElementById('play-btn').onclick = playHand;
        document.getElementById('discard-btn').onclick = discardCards;
        document.getElementById('sort-rank-btn').onclick = () => sortHand('rank');
        document.getElementById('sort-suit-btn').onclick = () => sortHand('suit');
        document.getElementById('view-deck-btn').onclick = showDeck;
        document.getElementById('close-deck').onclick = () => document.getElementById('deck-overlay').classList.add('hidden');
        document.getElementById('rules-btn').onclick = () => { playSound('select'); document.getElementById('rules-overlay').classList.remove('hidden'); };
        document.getElementById('close-rules').onclick = () => { playSound('select'); document.getElementById('rules-overlay').classList.add('hidden'); };
        document.getElementById('restart-game-btn').onclick = resetGame;
        document.getElementById('next-round-btn').onclick = () => { playSound('select'); state.isShopOpen = false; document.getElementById('shop-overlay').classList.add('hidden'); state.round++; startRound(); };
        window.onload = startRound;
    </script>
</body>
</html>
