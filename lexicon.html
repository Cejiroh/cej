<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lexicon</title>
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700&display=swap');

        :root {
            --bg-color: #d2b48c;
            --ink-black: #1c140d;
            --parchment-dark: #b89f7a;
            --green: #2d5a27;
            --yellow: #a67c00;
            --gray: #4a443f;
            --hazard: #4c0000;
            --invalid-red: #8b0000;
            --accent: #5d3a1a;
            --text: #2c1e14;
            --font-main: 'Crimson Text', serif;
            --font-title: 'Cinzel', serif;
            --screen-bg: radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.15) 100%);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--screen-bg), url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            color: var(--text);
            font-family: var(--font-main);
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.8s ease;
        }

        body.boss-active {
            background-color: #1a0f0a;
            --text: #d2b48c;
            --accent: #8b7355;
            --screen-bg: radial-gradient(circle at 50% 50%, rgba(76, 0, 0, 0.2) 0%, rgba(0,0,0,0.8) 100%);
        }

        #damage-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            box-shadow: inset 0 0 0px rgba(139, 0, 0, 0);
            z-index: 9999;
            transition: box-shadow 0.1s;
        }

        @keyframes bloodPulse {
            0% { box-shadow: inset 0 0 0px rgba(76, 0, 0, 0); }
            10% { box-shadow: inset 0 0 150px rgba(76, 0, 0, 0.9); }
            100% { box-shadow: inset 0 0 0px rgba(76, 0, 0, 0); }
        }
        .damage-flash { animation: bloodPulse 0.4s ease-out forwards; }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.03); }
            28% { transform: scale(1); }
            42% { transform: scale(1.03); }
            70% { transform: scale(1); }
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 95%;
            max-width: 500px;
            flex: 1;
            padding: 20px 0;
            position: relative;
            justify-content: center; 
            align-items: center;
            text-align: center;
            margin: 0 auto;
        }
        .screen.active { display: flex; }

        #main-header {
            display: none; 
            flex-shrink: 0;
            width: 95%;
            max-width: 500px;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 5px;
            padding: 8px 10px 12px 10px;
            background: #2c1e14;
            border: 3px solid #1c140d;
            margin-top: 10px;
            border-radius: 8px;
            color: #d2b48c;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .header-panel {
            background: #b89f7a;
            border: 1px solid #1c140d;
            border-radius: 4px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--ink-black);
            min-height: 60px;
            overflow: hidden;
        }

        .stat-label { font-size: 0.55rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); font-weight: bold; cursor: default; white-space: nowrap; }
        .stat-value { font-size: 0.9rem; font-weight: bold; line-height: 1.1; font-family: var(--font-title); white-space: nowrap; }
        .clickable-label:hover { color: var(--hazard); cursor: pointer; text-decoration: underline; }

        .hp-bar-container {
            width: 100%;
            height: 15px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #1c140d;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
            position: relative;
        }
        .hp-bar-fill { height: 100%; background: linear-gradient(to bottom, var(--hazard), #500); transition: width 0.5s ease; }
        #hp-val {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
            z-index: 5;
            pointer-events: none;
            letter-spacing: 1px;
        }

        .ribbon-btn {
            position: absolute;
            bottom: -28px;
            width: 36px;
            height: 44px;
            background: var(--hazard);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 50% 80%, 0% 100%);
            transition: transform 0.2s;
            z-index: 5;
            border: 1px solid #500;
            padding-bottom: 5px;
        }
        .ribbon-btn.home { left: 10px; background: #3d2b1f; border-color: #1a0f0a; }
        .ribbon-btn.surrender { right: 10px; background: var(--hazard); }
        .ribbon-btn.descend { right: 10px; background: var(--green); border-color: #1a3a16; }

        #grid-container { 
            flex: 1; 
            width: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            padding: 5px 0;
        }
        #grid { 
            display: grid; 
            gap: 4px; 
            justify-content: center; 
            align-content: center;
            width: 100%;
        }

        .tile {
            border: 2px solid #8b7355;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-transform: uppercase;
            background: #fdf5e6;
            color: var(--ink-black);
            position: relative;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-family: var(--font-title);
            border-radius: 4px;
            transition: background 0.3s;
        }
        .tile.correct { background-color: var(--green); color: #fff; border-color: #1a3a16; }
        .tile.present { background-color: var(--yellow); color: #fff; border-color: #6a5000; }
        .tile.absent { background-color: var(--gray); color: rgba(255,255,255,0.4); border-color: #222; }
        .tile.invalid { background-color: var(--invalid-red); color: #fff; border-color: #400; }
        .tile.hazard::after { content: '‚öî'; position: absolute; top: 0; right: 1px; font-size: 10px; color: var(--hazard); }
        .tile.blighted { background-color: #1a0f0a !important; color: transparent !important; border-color: #000 !important; box-shadow: inset 0 0 10px #000; }
        .tile.hidden { opacity: 0; visibility: hidden; }

        .keyboard { 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            padding: 10px 0 20px 0;
            width: 100%;
        }
        .kb-row { display: flex; justify-content: center; gap: 4px; width: 100%; }
        .key {
            height: 52px;
            flex: 1;
            background: #3d2b1f; color: #d2b48c; border: 1px solid #2a1d15;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 #1a0f0a; position: relative;
            text-transform: uppercase; 
            font-family: var(--font-title);
        }
        .key.large { flex: 1.5; font-size: 0.85rem; }
        .key.taxed::after { content: 'ü™ô'; position: absolute; top: -6px; right: -4px; font-size: 11px; }
        .key.corrupted { background: #500 !important; color: #f00 !important; box-shadow: 0 4px 0 #300 !important; }
        .key.correct { background: var(--green); box-shadow: 0 4px 0 #1a3a16; }
        .key.present { background: var(--yellow); box-shadow: 0 4px 0 #6a5000; }
        .key.absent { background: #222; color: #555; opacity: 0.6; box-shadow: none; transform: translateY(2px); }
        .key:active { transform: translateY(2px); box-shadow: 0 1px 0 #1a0f0a; }

        .difficulty-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 440px;
        }
        .diff-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--accent);
            background: rgba(28, 20, 13, 0.1);
            font-family: var(--font-title);
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.7rem;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .diff-btn.active {
            background: var(--accent);
            color: #d2b48c;
            border-color: var(--ink-black);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .diff-btn.locked {
            opacity: 0.4;
            cursor: not-allowed;
            background: #1a0f0a;
        }

        .archetype-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
            max-width: 460px;
            padding: 5px;
            margin-bottom: 8px;
        }
        .archetype-card { 
            background: #fdf5e6; 
            padding: 10px; 
            border: 1px solid var(--parchment-dark); 
            border-radius: 6px; 
            cursor: pointer; 
            text-align: left; 
            box-shadow: 2px 2px 0px var(--accent); 
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
        }
        .archetype-pb {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.55rem;
            font-family: var(--font-title);
            color: var(--accent);
            opacity: 0.6;
            font-weight: bold;
        }
        .archetype-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }
        .archetype-card:not(.locked):hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0px var(--hazard);
            border-color: var(--hazard);
        }
        .archetype-card h3 { 
            font-family: var(--font-title); 
            color: var(--ink-black); 
            font-size: 0.75rem; 
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 2px;
        }
        .archetype-vit {
            font-size: 0.55rem;
            font-weight: bold;
            color: #fff;
            background: var(--hazard);
            padding: 1px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-start;
            margin-bottom: 2px;
        }
        .archetype-card p { 
            font-size: 0.68rem; 
            color: var(--text); 
            opacity: 0.85; 
            line-height: 1.25;
            font-style: italic;
        }

        .btn { 
            background: #3d2b1f; color: #d2b48c; padding: 14px 25px; border: 3px double #d2b48c; border-radius: 6px; font-weight: bold; cursor: pointer; min-width: 250px; font-size: 1.1rem; font-family: var(--font-title); letter-spacing: 1px; margin: 10px 0; transition: transform 0.1s;
        }
        .btn.small { min-width: 150px; font-size: 0.85rem; padding: 10px; }

        .back-arrow {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--accent);
            z-index: 100;
        }

        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .shop-item { background: #fdf5e6; padding: 10px; border: 1.5px solid var(--ink-black); display: flex; flex-direction: column; justify-content: space-between; font-size: 0.8rem; box-shadow: 3px 3px 0 var(--ink-black); border-radius: 6px; text-align: left; }
        .shop-item.sold { opacity: 0.4; pointer-events: none; }
        .shop-tag { font-family: var(--font-title); font-size: 0.6rem; text-transform: uppercase; color: var(--accent); opacity: 0.7; }

        .consumables-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px 0; width: 100%; }
        .item-slot { width: 44px; height: 44px; background: #fdf5e6; border: 2px solid var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; box-shadow: 2px 2px 0 var(--accent); position: relative; }
        .item-slot.empty { opacity: 0.2; cursor: default; border-style: dashed; background: transparent; box-shadow: none; }
        
        .item-slot:hover::after {
            content: attr(data-desc);
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #1c140d;
            color: #d2b48c;
            padding: 5px 10px;
            font-size: 0.7rem;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            border: 1px solid #d2b48c;
        }
        .item-slot:hover::after { display: block; }

        .custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fdf5e6; border: 6px double var(--ink-black); padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; box-shadow: 0 10px 40px #000; width: 100%; }

        #respite-archive-box.boss-style, .boss-alert {
            background-color: #1a0f0a !important;
            background-image: radial-gradient(circle at 50% 50%, rgba(76, 0, 0, 0.4) 0%, rgba(0,0,0,0.9) 100%) !important;
            border: 3px double var(--hazard) !important;
            color: #d2b48c;
            box-shadow: 0 0 20px rgba(76, 0, 0, 0.5);
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        #respite-archive-box.boss-style h1, .boss-alert h1 { color: #f00 !important; text-shadow: 0 0 8px #000; }
        #respite-archive-box.boss-style p, .boss-alert p { color: #8b7355 !important; }

        .confirm-actions { display: flex; gap: 10px; width: 100%; justify-content: center; }
        .confirm-actions .btn { min-width: 0; flex: 1; margin: 0; }

        .rules-modal-container { 
            background: #fdf5e6; color: var(--text); padding: 25px; border: 6px double var(--ink-black); border-radius: 12px; width: 95%; max-width: 500px; text-align: left; max-height: 85vh; overflow-y: auto;
        }
        .rules-modal-container h2 { text-align: center; font-family: var(--font-title); color: var(--hazard); margin-bottom: 20px; }
        .rules-modal-container h3 { font-family: var(--font-title); color: var(--hazard); margin: 25px 0 10px 0; border-bottom: 2px solid var(--parchment-dark); font-size: 1.1rem; }
        
        #codex-bosses, #codex-relics, #codex-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 15px;
            align-items: start;
        }

        @media (max-width: 480px) {
            #codex-bosses {
                grid-template-columns: 1fr;
            }
        }

        .codex-entry { margin-bottom: 12px; }
        .codex-name { font-weight: bold; color: var(--ink-black); font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        .codex-desc { font-size: 0.8rem; line-height: 1.3; color: var(--accent); font-style: italic; display: block; margin-top: 2px; }

        #modifiers-bar { text-align: center; }
        .boss-info { display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .boss-name-ui { color: #f00; text-shadow: 0 0 5px #000; letter-spacing: 1px; font-weight: bold; font-family: var(--font-title); }
        .boss-desc-ui { font-size: 0.75rem; color: #aaa; font-style: italic; margin-top: 2px; }

        #timer-display { font-family: var(--font-title); color: var(--hazard); font-size: 1.2rem; margin-top: 5px; font-weight: bold; display: none; }

        .message-toast { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: #1c140d; color: #d2b48c; padding: 12px 24px; border: 2px solid #d2b48c; border-radius: 8px; opacity: 0; z-index: 3000; transition: 0.3s; box-shadow: 0 4px 15px #000; font-family: var(--font-title); text-align: center; font-size: 0.9rem; pointer-events: none; }
        .message-toast.show { opacity: 1; transform: translate(-50%, 20px); }

        .boss-alert { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; width: 90%; max-width: 400px; z-index: 4000; text-align: center; display: none; border-radius: 12px; }
        .boss-alert h1 { font-family: var(--font-title); font-size: 2rem; margin-bottom: 12px; letter-spacing: 2px; }

        .loading-quill {
            font-size: 3.5rem;
            margin-bottom: 30px;
            animation: quill-writing 2s ease-in-out infinite;
        }
        @keyframes quill-writing {
            0%, 100% { transform: translate(0, 0) rotate(15deg); }
            25% { transform: translate(15px, -10px) rotate(30deg); }
            50% { transform: translate(-10px, 5px) rotate(10deg); }
            75% { transform: translate(10px, -5px) rotate(25deg); }
        }

        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { opacity: 0; } 40% { opacity: 1; } 60% { text-shadow: .25em 0 0 var(--text); } 80%, 100% { text-shadow: .25em 0 0 var(--text), .5em 0 0 var(--text); } }

        /* Tutorial specific list styling */
        .tutorial-list { text-align: left; font-size: 0.85rem; margin: 15px 0; line-height: 1.4; color: var(--accent); }
        .tutorial-list li { margin-bottom: 8px; }

        .tutorial-key {
            display: inline-flex;
            width: 32px;
            height: 32px;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
            font-family: var(--font-title);
            margin-right: 8px;
            vertical-align: middle;
            color: #fff;
            box-shadow: 0 3px 0 rgba(0,0,0,0.4);
            font-size: 0.95rem;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }

        /* Helper to ensure tutorial tiles look exactly like game tiles */
        .tile-example {
            width: 32px !important;
            height: 32px !important;
            display: inline-flex !important;
            vertical-align: middle !important;
            margin-right: 8px !important;
            font-size: 0.9rem !important;
            cursor: default !important;
        }

        /* Name input styling */
        .name-input {
            background: #fdf5e6;
            border: 2px solid var(--accent);
            padding: 10px;
            width: 100%;
            font-family: var(--font-title);
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body id="game-body">

    <div id="damage-overlay"></div>

    <div id="main-header">
        <div class="ribbon-btn home" onclick="goHome()">‚åÇ</div>
        <div class="ribbon-btn surrender" id="surrender-ribbon">üè≥</div>
        
        <!-- Left: Floor and Score -->
        <div class="header-panel">
            <div id="floor-val-header" class="stat-value" style="font-size: 1.1rem;">Floor I</div>
            <div id="score-val" style="font-size: 0.75rem; font-weight: bold;">0 Points</div>
        </div>

        <!-- Center: Name and Soul + VIT bar -->
        <div class="header-panel">
            <div id="player-name-val" class="stat-value clickable-label" style="font-size: 0.9rem;" onclick="openNamePopup()">Name</div>
            <div id="soul-name-val" class="stat-label" style="font-size: 0.5rem; letter-spacing: 1px;">SOUL</div>
            <div class="hp-bar-container">
                <div id="hp-bar" class="hp-bar-fill"></div>
                <div id="hp-val">60 / 60</div>
            </div>
        </div>

        <!-- Right: Coins and Relics -->
        <div class="header-panel">
            <div class="stat-label">Coins</div>
            <div id="coins-subval" class="stat-value">0</div>
            <div id="active-relics" style="display:flex; gap:3px; margin-top:2px;"></div>
        </div>
    </div>

    <!-- Codex Modal -->
    <div id="rules-modal" class="custom-modal" onclick="closeRules(event)">
        <div class="rules-modal-container" onclick="event.stopPropagation()">
            <h2>THE CODEX</h2>
            
            <h3>The Trials (Bosses)</h3>
            <div id="codex-bosses"></div>

            <h3>The Reliquary (Powers)</h3>
            <div id="codex-relics"></div>

            <h3>The Archive (Items)</h3>
            <div id="codex-items"></div>

            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('rules-modal').style.display='none'">Close Codex</button>
        </div>
    </div>

    <div id="confirm-modal" class="custom-modal">
        <div class="modal-box">
            <h2 id="confirm-title" class="title">Use Item?</h2>
            <p id="confirm-desc" style="margin: 15px 0 25px 0; font-style: italic;"></p>
            <div class="confirm-actions">
                <button class="btn" id="confirm-yes">Yes</button>
                <button class="btn" onclick="document.getElementById('confirm-modal').style.display='none'" style="background:transparent; color:var(--accent); border: 2px solid var(--accent);">No</button>
            </div>
        </div>
    </div>

    <!-- Name Entry Modal -->
    <div id="name-modal" class="custom-modal">
        <div class="modal-box">
            <h2 class="title">What is your name?</h2>
            <p style="margin-bottom: 20px; font-style: italic;">Enter up to 10 characters.</p>
            <input type="text" id="name-entry" class="name-input" maxlength="10" placeholder="Stranger">
            <button class="btn" onclick="submitName()">Confirm Identity</button>
        </div>
    </div>

    <!-- New Tutorial Modal -->
    <div id="tutorial-modal" class="custom-modal">
        <div class="modal-box">
            <h2 class="title" style="color: var(--green);">HOW TO PLAY</h2>
            <ul class="tutorial-list">
                <li><b>Spelling</b>: Guess the hidden word.
                    <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px;">
                        <div><span class="tile tile-example correct">‚úì</span> <b>Green</b>: Correct letter on a correct tile.</div>
                        <div><span class="tile tile-example present">?</span> <b>Yellow</b>: Correct letter, but misplaced spot.</div>
                        <div><span class="tile tile-example invalid">x</span> <b>Red</b>: Invalid word. Guess not in dictionary.</div>
                    </div>
                </li>
                <li style="margin-top: 15px;"><b>Vitality</b>: Failing to guess a word or hitting ‚öîÔ∏è Hazards deals damage. If VIT reaches 0, the run ends.</li>
                <li><b>Coins</b>: Earn coins by guessing words correctly. Spend them in the <b>Library</b> for Items and Relics.</li>
                <li><b>Trials</b>: Every 4 floors, you face a <b>Boss</b> with unique debilitating effects.</li>
            </ul>
            <button class="btn" onclick="closeTutorial()">Begin Descent</button>
        </div>
    </div>

    <div id="save-prompt" class="custom-modal">
        <div class="modal-box">
            <h2 class="title" style="font-size: 2rem;">Resurrect?</h2>
            <p style="margin-bottom: 30px; font-style: italic;">A soul remains trapped on Floor <span id="save-floor-val">I</span>.</p>
            <button class="btn" onclick="AudioEngine.playKey(); loadGame()">Continue Ascent</button>
            <button class="btn" style="background:var(--hazard); color: white; border-color: black;" onclick="AudioEngine.playHurt(); deleteSaveAndStart()">New Sacrifice</button>
        </div>
    </div>

    <div id="surrender-modal" class="custom-modal">
        <div class="modal-box">
            <h2 class="title" style="color: var(--hazard);">ABANDON?</h2>
            <p style="margin-bottom: 25px;">Suffer Vitality loss and skip reward?</p>
            <button class="btn" onclick="executeSurrender()" style="background:var(--hazard); color:white; border-color: black;">Yes, Retreat</button>
            <button class="btn" onclick="AudioEngine.playShop(); document.getElementById('surrender-modal').style.display='none'">No, Fight On</button>
        </div>
    </div>

    <div id="victory-modal" class="custom-modal">
        <div class="modal-box">
            <h2 class="title" style="color: var(--yellow);">ARCHIVE COMPLETE</h2>
            <p style="margin-bottom: 25px;">Will you retire or descend into the Endless Void?</p>
            <button class="btn" onclick="AudioEngine.playCorrect(); startEndless()" style="background:var(--accent); color:white;">Endless Mode</button>
            <button class="btn" onclick="AudioEngine.playKey(); goHome()">Retire in Glory</button>
        </div>
    </div>

    <!-- Screens -->
    <div id="screen-loading" class="screen active">
        <div class="loading-quill">üñãÔ∏è</div>
        <h2 class="title" style="font-size: 3.5rem; letter-spacing: 8px;">LEXICON</h2>
        <p class="subtitle loading-dots">Summoning the Great Library</p>
    </div>

    <div id="screen-start" class="screen">
        <h1 class="title" style="font-size: 4rem; letter-spacing: 10px;">LEXICON</h1>
        <p style="font-style: italic; margin-bottom: 10px;">‚Äî A Rogue‚Äôs Descent ‚Äî</p>
        <p id="highscore-display" style="font-size: 0.9rem; margin-bottom: 5px; font-family: var(--font-title); color: var(--accent);">Highest Floor: I</p>
        <p id="high-score-total" style="font-size: 0.8rem; margin-bottom: 20px; font-family: var(--font-title); color: var(--green);">Highest Score: 0</p>
        <button class="btn" onclick="AudioEngine.init(); AudioEngine.playShop(); checkAbyssEntry()">Enter the Abyss</button>
        <button class="btn" onclick="AudioEngine.init(); AudioEngine.playShop(); openTutorial()">How to Play</button>
        <button class="btn" onclick="AudioEngine.init(); AudioEngine.playShop(); openCodex()">The Codex</button>
    </div>

    <div id="screen-archetype" class="screen">
        <div class="back-arrow" onclick="AudioEngine.playKey(); showScreen('screen-start')">‚Üê</div>
        <h2 class="title" style="margin-bottom: 2px; font-size: 1.5rem; letter-spacing: 1px;">Soul Selection</h2>
        <p id="diff-description" style="font-size: 0.72rem; color: var(--accent); font-style: italic; margin-bottom: 12px; height: 1.2em;">Choose your destiny.</p>
        
        <div class="archetype-list" id="archetype-list" style="grid-template-columns: 1fr 1fr; max-height: 70vh; overflow-y: auto; padding-right: 5px;">
            <div class="archetype-card" onclick="startRun('outcast')">
                <div class="archetype-pb" id="pb-outcast">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 60 VIT</div>
                <h3>The Outcast</h3>
                <p>No spelling penalties. Standard path.</p>
            </div>
            <div class="archetype-card" id="arch-withered" onclick="startRun('withered')">
                <div class="archetype-pb" id="pb-withered">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 60 VIT</div>
                <h3>The Withered</h3>
                <p>Halves all damage taken.</p>
            </div>
            <div class="archetype-card" id="arch-tinker" onclick="startRun('tinker')">
                <div class="archetype-pb" id="pb-tinker">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 50+ VIT</div>
                <h3>The Tinker</h3>
                <p>+10 Max VIT per item held. Items consume Max VIT.</p>
            </div>
            <div class="archetype-card" id="arch-prodigy" onclick="startRun('prodigy')">
                <div class="archetype-pb" id="pb-prodigy">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 50 VIT</div>
                <h3>The Prodigy</h3>
                <p>Starts floors with 1 Correct letter.</p>
            </div>
            <div class="archetype-card" id="arch-merchant" onclick="startRun('merchant')">
                <div class="archetype-pb" id="pb-merchant">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 90 VIT</div>
                <h3>The Merchant</h3>
                <p>Permanent 25% shop discount.</p>
            </div>
            <div class="archetype-card" id="arch-hunter" onclick="startRun('hunter')">
                <div class="archetype-pb" id="pb-hunter">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 100 VIT</div>
                <h3>The Boss Hunter</h3>
                <p>Trials on every floor. Gains random relic at the start.</p>
            </div>
            <div class="archetype-card" id="arch-bloodstained" onclick="startRun('bloodstained')">
                <div class="archetype-pb" id="pb-bloodstained">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 120 VIT</div>
                <h3>The Bloodstained</h3>
                <p>Does not gain gold. Everything costs VIT.</p>
            </div>
            <div class="archetype-card" id="arch-cursed" onclick="startRun('cursed')">
                <div class="archetype-pb" id="pb-cursed">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 110 VIT</div>
                <h3>The Cursed One</h3>
                <p>Invalid words grant Gold multiplier.</p>
            </div>
            <div class="archetype-card" id="arch-anchor" onclick="startRun('anchor')">
                <div class="archetype-pb" id="pb-anchor">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 60 VIT</div>
                <h3>The Iron Oath</h3>
                <p>Last 2 attempts ignore Boss effects.</p>
            </div>
            <div class="archetype-card" id="arch-slayer" onclick="startRun('slayer')">
                <div class="archetype-pb" id="pb-slayer">BF: I</div>
                <div class="archetype-vit">‚ù§Ô∏è 60 VIT</div>
                <h3>The Slayer</h3>
                <p>+10 Max VIT on Trial win.</p>
            </div>
        </div>
        
        <div class="difficulty-selector" id="difficulty-selector-container">
            <button id="diff-easy" class="diff-btn active" onclick="AudioEngine.playKey(); setDiff('easy', this)">Easy</button>
            <button id="diff-medium" class="diff-btn" onclick="AudioEngine.playKey(); setDiff('medium', this)">Medium</button>
            <button id="diff-hard" class="diff-btn" onclick="AudioEngine.playKey(); setDiff('hard', this)">Hard</button>
        </div>
    </div>

    <div id="screen-game" class="screen" style="justify-content: flex-start;">
        <div id="modifiers-bar" style="margin: 10px 0; font-family: var(--font-title); font-size: 0.75rem; color: var(--hazard); font-weight: bold; min-height: 2.2em;"></div>
        <div id="timer-display">03:00</div>
        <div id="grid-container"><div id="grid"></div></div>
        <div class="consumables-bar" id="inventory-game"></div>
        <div class="keyboard" id="keyboard">
            <div class="kb-row" id="kb-1"></div>
            <div class="kb-row" id="kb-2"></div>
            <div class="kb-row" id="kb-3"></div>
        </div>
    </div>

    <div id="screen-respite" class="screen">
        <h2 class="title" style="margin-bottom: 10px; font-size: 2.2rem;">RESPITE</h2>
        <div id="respite-archive-box" class="modal-box" style="background: rgba(0,0,0,0.05); border: 2px solid var(--accent); width: 100%;">
            <p id="respite-label" style="font-family: var(--font-title); font-size: 0.8rem; color: var(--accent); text-transform: uppercase;">Last Archive</p>
            <h1 id="respite-header" style="font-family: var(--font-title); margin: 5px 0 15px 0; letter-spacing: 4px; color: var(--green);">WORD</h1>
            <p id="respite-subtext" style="font-style: italic; font-size: 0.9rem; margin-top: 10px;"></p>
        </div>
        
        <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px; width: 100%;">
            <button class="btn" onclick="AudioEngine.playShop(); enterShop()">Enter the Library</button>
            <button class="btn" id="rest-btn" style="background: var(--green); color: white; border-color: black;" onclick="executeRest()">Take a Rest</button>
        </div>
    </div>

    <div id="screen-shop" class="screen" style="justify-content: flex-start;">
        <h2 class="title" style="margin: 20px 0;">Library</h2>
        <div id="shop-items" class="shop-grid"></div>
        <p style="margin: 20px 0; font-family: var(--font-title);">Backpack</p>
        <div class="consumables-bar" id="inventory-shop"></div>
    </div>

    <div id="screen-gameover" class="screen">
        <h1 class="title" style="color: var(--hazard); font-size: 4rem;">Consumed</h1>
        <p id="game-summary" style="margin-bottom: 5px; font-style: italic;"></p>
        <p id="game-final-score" style="margin-bottom: 10px; font-weight: bold; font-family: var(--font-title);"></p>
        <p id="game-last-word" style="font-weight: bold; color: var(--hazard); margin-bottom: 20px;"></p>
        <button class="btn" onclick="AudioEngine.playShop(); showScreen('screen-archetype')">Reincarnate</button>
    </div>

    <div id="boss-alert" class="boss-alert">
        <h1 id="boss-name">BOSS</h1>
        <p id="boss-desc" style="font-style: italic; margin-bottom: 25px;"></p>
        <button class="btn" onclick="AudioEngine.playShop(); hideBossAlert()" style="width: 100%; border-color: #500; background: #300;">Continue</button>
    </div>

    <div id="toast" class="message-toast"></div>

    <script>
        (function() {
            const BOSS_DATA = {
                "Tax": "3 random letters cost 5 coins.",
                "Glitch": "Deciever lies about one color result.",
                "VoidScramble": "The Void scrambles 2 keys per guess.",
                "Censor": "Incorrect guesses deal damage equal to word length.",
                "Blight": "Shadow consumes passing rows.",
                "Illusionist": "Correct letters disguised as Misplaced.",
                "Silence": "Backpack items are unusable.",
                "Siren": "Vowels remain neutral on the grid.",
                "Phantom": "Feedback is delayed by one turn.",
                "Corrupt": "Keys deals 3 damage.",
                "Clock": "Win before the 3:00 timer reaches zero."
            };

            const CURATED_TARGETS = {
                4: ["book", "page", "font", "word", "ink", "read", "sign", "tale", "lore", "myth", "bard", "text", "poem", "verb", "writ", "city", "cold", "dark", "data", "fire", "fish", "gold", "hand", "hard", "home", "hope", "kind", "king", "land", "life", "love", "moon", "name", "near", "open", "path", "play", "rain", "real", "road", "rock", "save", "star", "time", "tree", "true", "walk", "wind", "work", "year", "milk", "silk", "cake", "lake", "meal", "boat", "coat", "lamp", "camp", "heal", "meat", "neat", "beat", "feel", "dead", "pest", "test", "west", "east"],
                12: ["professional", "relationship", "organization", "construction", "introduction", "distribution", "architecture", "intelligence"]
            };

            const ITEMS = {
                'potion': { emoji: 'üß™', name: 'Health Potion', desc: 'Heal 15 Vitality.', cost: 5, type: 'cons', run: () => heal(15) },
                'dust': { emoji: 'üëÅÔ∏è', name: 'Scryer Dust', desc: 'Reveal non-green letter.', cost: 25, type: 'cons', run: () => revealOne() },
                'sunstone': { emoji: '‚òÄÔ∏è', name: 'Sunstone', desc: 'Highlight 2 Yellow keys.', cost: 40, type: 'cons', run: () => {
                    const targets = [];
                    for(let char of window.G.targetWord) {
                        if(window.G.keyStatus[char] !== 'correct' && window.G.keyStatus[char] !== 'present') targets.push(char);
                    }
                    const unique = [...new Set(targets)];
                    for(let i=0; i<2; i++) {
                        if(unique.length) {
                            const pick = unique.splice(Math.floor(Math.random()*unique.length), 1)[0];
                            window.G.keyStatus[pick] = 'present';
                        }
                    }
                    renderKeyboard(); toast("Yellows Highlighted");
                }},
                'scroll': { emoji: 'üìú', name: 'Extra Page', desc: 'Add +1 guess attempt.', cost: 40, type: 'cons', run: () => { window.G.maxGuesses++; renderGrid(); toast("+1 Attempt Added"); } },
                'purge': { emoji: 'üßπ', name: 'Purge Scroll', desc: 'Remove 5 wrong keys.', cost: 30, type: 'cons', run: () => purgeKeys() },
                'coupon': { emoji: 'üéüÔ∏è', name: 'Haggler Charm', desc: '50% off next buy.', cost: 65, type: 'cons', run: () => { window.G.discountActive = true; toast("Price Halved"); renderShop(); } },
                'bell': { emoji: 'üîî', name: 'Warding Bell', desc: 'Ignore 1 boss effect for that entire floor.', cost: 50, type: 'cons', run: () => { 
                    if (window.G.modifiers.length > 0) {
                        window.G.suppressedModifier = window.G.modifiers[Math.floor(Math.random() * window.G.modifiers.length)];
                        window.G.wardActive = true;
                        toast(`Warding ${window.G.suppressedModifier}`);
                    } else {
                        toast("No effects to ward.");
                    }
                } },
                'masterkey': { emoji: 'üîë', name: 'Master Key', desc: 'Solve instantly (No gold).', cost: 150, type: 'cons', run: () => solveWord() },
                'feather': { emoji: 'ü™∂', name: 'Phoenix Feather', desc: 'Revive once at 50% VIT.', cost: 230, type: 'perm', run: () => { window.G.upgrades.push('feather'); window.G.hasPhoenix = true; } },
                'midas': { emoji: 'ü™ô', name: 'Midas Touch', desc: '+15 Coins per win.', cost: 110, type: 'perm', run: () => { window.G.upgrades.push('midas'); } },
                'dict': { emoji: 'üìñ', name: 'Encyclopedia', desc: '+1 Max Guess per floor.', cost: 160, type: 'perm', run: () => { window.G.maxGuesses++; window.G.upgrades.push('dict'); } },
                'vamp': { emoji: 'üñãÔ∏è', name: 'Vampiric Ink', desc: 'Heal on new Green tiles.', cost: 140, type: 'perm', run: () => { window.G.upgrades.push('vamp'); } },
                'satchel': { emoji: 'üéí', name: 'Satchel', desc: '+1 Backpack Space.', cost: 120, type: 'perm', run: () => { window.G.consumables.push(null); window.G.upgrades.push('satchel'); } },
                'heart': { emoji: '‚ù§Ô∏è', name: 'Ancient Heart', desc: '+20 Max Vitality.', cost: 130, type: 'perm', run: () => { window.G.maxHp += 20; window.G.hp += 20; window.G.upgrades.push('heart'); } },
                'armor': { emoji: 'üõ°Ô∏è', name: 'Plate Armor', desc: '-5 Damage taken.', cost: 140, type: 'perm', run: () => { window.G.upgrades.push('armor'); } },
                'clarity': { emoji: 'üí†', name: 'Runestone', desc: 'True colors revealed.', cost: 150, type: 'perm', run: () => { window.G.upgrades.push('clarity'); } },
                'ledger': { emoji: '‚úçÔ∏è', name: 'Hollow Quill', desc: '+1 Coin per Grey.', cost: 140, type: 'perm', run: () => { window.G.upgrades.push('ledger'); } },
                'compass': { emoji: 'üß≠', name: "Seer's Compass", desc: 'Highlight 1 Yellow per floor.', cost: 150, type: 'perm', run: () => { window.G.upgrades.push('compass'); } }
            };

            const BOSS_LIST = [
                { name: "THE SILENCED", desc: "3 letters taxed 5 Coins.", mod: "Tax" },
                { name: "THE DECIEVER", desc: "Lies about one tile color.", mod: "Glitch" },
                { name: "THE VOID", desc: "Keys scramble into symbols.", mod: "VoidScramble" },
                { name: "THE CENSOR", desc: "Incorrect guesses deal damage equal to word length.", mod: "Censor" },
                { name: "THE BLIGHT", desc: "Passing rows are hidden.", mod: "Blight" },
                { name: "THE ILLUSIONIST", desc: "Correct tiles appear Misplaced.", mod: "Illusionist" },
                { name: "THE HERMIT", desc: "Items are unusable.", mod: "Silence" },
                { name: "THE SIREN", desc: "Vowels remain neutral on the grid.", mod: "Siren" },
                { name: "THE PHANTOM", desc: "Feedback is delayed by one turn.", mod: "Phantom" },
                { name: "THE CORRUPTOR", desc: "Keys deals 3 damage.", mod: "Corrupt" },
                { name: "THE CLOCKMAKER", desc: "3 minute time limit.", mod: "Clock" },
                { name: "THE CHIMERA", desc: "Uses multiple boss effects.", mod: "Chimera" }
            ];

            const archNames = {
                outcast: "The Outcast", withered: "The Withered", tinker: "The Tinker", prodigy: "The Prodigy", merchant: "The Merchant", hunter: "The Boss Hunter", bloodstained: "The Bloodstained", cursed: "The Cursed One", anchor: "The Iron Oath", slayer: "The Slayer"
            };

            var kbLayout = [ "qwertyuiop".split(""), "asdfghjkl".split(""), ["DEL", ..."zxcvbnm".split(""), "‚èé"] ];
            let timerInterval = null;
            let delRepeatInterval = null;

            window.AudioEngine = {
                ctx: null,
                init() { if (this.ctx) return; this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
                playKey() { if (!this.ctx) return; this.beep(1200, 'sine', 0.02, 0.06); },
                beep(freq, type, dur, vol) {
                    if (!this.ctx) return;
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.start(); osc.stop(this.ctx.currentTime + dur);
                },
                playCorrect() { this.beep(400, 'sine', 0.1, 0.1); this.beep(600, 'sine', 0.2, 0.1); },
                playWrong() { this.beep(200, 'square', 0.3, 0.1); },
                playHurt() { this.beep(120, 'sawtooth', 0.3, 0.2); },
                playShop() { this.beep(800, 'sine', 0.1, 0.05); }
            };

            var FULL_LEXICON = {};
            var EASY_LEXICON = {};

            function createInitialState() {
                return {
                    playerName: localStorage.getItem('lexicon_player_name') || "",
                    hp: 60, maxHp: 60, coins: 0, floor: 1, totalScore: 0, targetWord: "", currentGuess: "", guesses: [], maxGuesses: 5, archetype: 'outcast', difficulty: 'easy', upgrades: [], consumables: [null, null, null], keyStatus: {}, forbiddenLetters: new Set(), hazardTiles: [], scrambledKeys: {}, wardActive: false, suppressedModifier: null, isGameOver: false, modifiers: [], bossActive: null, hints: {}, floorPurchases: new Set(), discountActive: false, currentShopPool: [], midFloor: false, hasPhoenix: false, isEndless: false, unknownCount: 0, corruptedKeys: [], timerSeconds: 180, taxedLetters: [], solveFlag: false, availableBosses: [], facedAllBosses: false, invalidWordBonus: 0, currentScreen: 'screen-game', tinkerBonus: 0
                };
            }

            window.G = createInitialState();

            const romNums = ["0","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX","XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX"];

            function showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                
                const body = document.getElementById('game-body');
                if (id !== 'screen-game' && id !== 'screen-respite') {
                    body.classList.remove('boss-active');
                    document.getElementById('confirm-modal').style.display = 'none';
                    document.getElementById('boss-alert').style.display = 'none';
                    stopTimer();
                }
                
                const header = document.getElementById('main-header');
                const surrenderBtn = document.getElementById('surrender-ribbon');
                
                if (id === 'screen-start') {
                    const highFloor = localStorage.getItem('lexicon_high_score') || 0;
                    const highScore = localStorage.getItem('lexicon_high_score_total') || 0;
                    document.getElementById('highscore-display').innerText = `Highest Floor: ${romNums[highFloor] || highFloor}`;
                    document.getElementById('high-score-total').innerText = `Highest Score: ${highScore}`;
                }

                if (id === 'screen-archetype') {
                    const high = parseInt(localStorage.getItem('lexicon_high_score') || 0);
                    const archetypes = Object.keys(archNames);
                    
                    archetypes.forEach(arch => {
                        const pbVal = localStorage.getItem(`lexicon_high_score_${arch}`) || 1;
                        const pbElement = document.getElementById(`pb-${arch}`);
                        if (pbElement) pbElement.innerText = `BF: ${romNums[pbVal] || pbVal}`;
                        const card = document.getElementById(`arch-${arch}`) || document.querySelector(`.archetype-card[onclick*="'${arch}'"]`);
                        if (!card) return;
                        if (arch !== 'outcast' && high < 8) card.classList.add('locked');
                        else card.classList.remove('locked');
                    });

                    document.getElementById('diff-medium').classList.toggle('locked', high < 20);
                    document.getElementById('diff-hard').classList.toggle('locked', high < 21);
                    
                    const diffContainer = document.getElementById('difficulty-selector-container');
                    if (high < 20) diffContainer.style.display = 'none';
                    else diffContainer.style.display = 'flex';
                    
                    updateDifficultyInfo();
                }

                if (id === 'screen-game' || id === 'screen-shop' || id === 'screen-respite') {
                    header.style.display = 'grid';
                    if (id === 'screen-game') {
                        surrenderBtn.innerText = 'üè≥'; 
                        surrenderBtn.className = 'ribbon-btn surrender';
                        surrenderBtn.onclick = () => document.getElementById('surrender-modal').style.display='flex';
                        setTimeout(() => renderGrid(), 10);
                        if(window.G.modifiers.includes("Clock")) startTimer();
                    } else {
                        surrenderBtn.innerText = '‚ûî'; 
                        surrenderBtn.className = 'ribbon-btn descend';
                        surrenderBtn.onclick = nextFloor;
                    }
                } else header.style.display = 'none';

                if (window.G && ['screen-game', 'screen-shop', 'screen-respite'].includes(id)) {
                    window.G.currentScreen = id;
                    saveGame();
                }
            }
            window.showScreen = showScreen;

            window.openCodex = () => {
                const bCont = document.getElementById('codex-bosses');
                const rCont = document.getElementById('codex-relics');
                const iCont = document.getElementById('codex-items');
                bCont.innerHTML = ""; rCont.innerHTML = ""; iCont.innerHTML = "";

                BOSS_LIST.forEach(b => {
                    bCont.innerHTML += `<div class="codex-entry"><span class="codex-name">üíÄ ${b.name}</span><span class="codex-desc">${b.desc}</span></div>`;
                });

                Object.keys(ITEMS).forEach(k => {
                    const item = ITEMS[k];
                    const entry = `<div class="codex-entry"><span class="codex-name">${item.emoji} ${item.name}</span><span class="codex-desc">${item.desc}</span></div>`;
                    if (item.type === 'perm') rCont.innerHTML += entry;
                    else iCont.innerHTML += entry;
                });

                document.getElementById('rules-modal').style.display = 'flex';
            };

            function startTimer() {
                document.getElementById('timer-display').style.display = 'block';
                stopTimer();
                timerInterval = setInterval(() => {
                    window.G.timerSeconds--;
                    updateTimerUI();
                    if(window.G.timerSeconds <= 0) {
                        stopTimer();
                        toast("Time Expired!");
                        loseFloor();
                    }
                }, 1000);
            }
            function stopTimer() { if(timerInterval) clearInterval(timerInterval); document.getElementById('timer-display').style.none = 'none'; }
            function updateTimerUI() {
                const m = Math.floor(window.G.timerSeconds / 60);
                const s = window.G.timerSeconds % 60;
                document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                updateUI();
            }

            async function loadLexicon() {
                try {
                    const r = await fetch('https://raw.githubusercontent.com/benjamincrom/scrabble/master/scrabble/dictionary.json');
                    const data = await r.json();
                    data.forEach(w => { if(w.length>=4 && w.length<=12) { if(!FULL_LEXICON[w.length]) FULL_LEXICON[w.length] = new Set(); FULL_LEXICON[w.length].add(w.toLowerCase()); } });
                } catch(e) { 
                    Object.keys(CURATED_TARGETS).forEach(l => { 
                        FULL_LEXICON[l] = new Set(CURATED_TARGETS[l]); 
                    }); 
                }

                try {
                    const r2 = await fetch('https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-no-swears.txt');
                    const text = await r2.text();
                    const words = text.split('\n');
                    words.forEach(w => {
                        const word = w.trim().toLowerCase();
                        if(word.length >= 4 && word.length <= 12) {
                            if(!EASY_LEXICON[word.length]) EASY_LEXICON[word.length] = new Set();
                            EASY_LEXICON[word.length].add(word);
                        }
                    });
                } catch(e) {
                    EASY_LEXICON = FULL_LEXICON;
                }

                showScreen('screen-start');
            }

            window.checkAbyssEntry = () => {
                const saved = localStorage.getItem('lexicon_run_save');
                const savedName = localStorage.getItem('lexicon_player_name');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.hp <= 0 || data.isGameOver) {
                        localStorage.removeItem('lexicon_run_save');
                        if (!savedName) openNamePopup(); else showScreen('screen-archetype');
                    } else {
                        document.getElementById('save-floor-val').innerText = data.floor;
                        document.getElementById('save-prompt').style.display = 'flex';
                    }
                } else {
                    if (!savedName) openNamePopup(); else showScreen('screen-archetype');
                }
            };

            window.openNamePopup = () => {
                document.getElementById('name-entry').value = window.G.playerName || "";
                document.getElementById('name-modal').style.display = 'flex';
            };

            window.submitName = () => {
                const input = document.getElementById('name-entry').value.trim();
                const name = input || "Stranger";
                window.G.playerName = name;
                localStorage.setItem('lexicon_player_name', name);
                document.getElementById('name-modal').style.display = 'none';
                if (document.getElementById('screen-start').classList.contains('active')) {
                    showScreen('screen-archetype');
                } else {
                    updateUI();
                }
            };

            window.deleteSaveAndStart = () => { 
                localStorage.removeItem('lexicon_run_save'); 
                document.getElementById('save-prompt').style.display = 'none'; 
                const savedName = localStorage.getItem('lexicon_player_name');
                if (!savedName) openNamePopup(); else showScreen('screen-archetype');
            };

            window.loadGame = () => { 
                const saved = localStorage.getItem('lexicon_run_save');
                if (saved) {
                    window.G = JSON.parse(saved);
                    window.G.forbiddenLetters = new Set(window.G.forbiddenLetters);
                    window.G.floorPurchases = new Set(window.G.floorPurchases);
                    document.getElementById('save-prompt').style.display = 'none';
                    AudioEngine.init();

                    const target = window.G.currentScreen || 'screen-game';

                    if (target === 'screen-game') {
                        showScreen('screen-game');
                        updateUI();
                        renderGrid();
                        renderKeyboard();
                    } else if (target === 'screen-respite') {
                        openRespite();
                        updateUI();
                    } else if (target === 'screen-shop') {
                        showScreen('screen-shop');
                        renderShop();
                        updateUI();
                    } else {
                        if (window.G.midFloor) { showScreen('screen-game'); updateUI(); renderGrid(); renderKeyboard(); } 
                        else initFloor();
                    }
                }
            };

            window.startRun = (type) => {
                const card = document.getElementById(`arch-${type}`) || document.querySelector(`.archetype-card[onclick*="'${type}'"]`);
                if (card && card.classList.contains('locked')) {
                    toast("Reach Floor VIII to unlock.");
                    return;
                }
                
                AudioEngine.init(); AudioEngine.playShop();
                const diff = window.G.difficulty;
                const pName = localStorage.getItem('lexicon_player_name') || "Stranger";
                window.G = createInitialState();
                window.G.archetype = type; window.G.difficulty = diff;
                window.G.playerName = pName;
                
                if(type === 'withered') { window.G.hp = window.G.maxHp = 60; }
                else if(type === 'tinker') { window.G.hp = window.G.maxHp = 50; window.G.consumables = [null, null, null, null]; }
                else if(type === 'prodigy') { window.G.hp = window.G.maxHp = 50; }
                else if(type === 'merchant') { window.G.hp = window.G.maxHp = 90; }
                else if(type === 'hunter') { window.G.hp = window.G.maxHp = 100; }
                else if(type === 'bloodstained') { window.G.hp = window.G.maxHp = 120; }
                else if(type === 'cursed') { window.G.hp = window.G.maxHp = 110; }
                else { window.G.hp = window.G.maxHp = 60; }
                
                window.G.coins = (type === 'hunter') ? 100 : 50; 
                if(type === 'bloodstained') window.G.coins = 0;
                
                window.G.maxGuesses = (diff === 'easy' ? 6 : 5);

                window.G.availableBosses = BOSS_LIST.map(b => b.mod).filter(m => m !== 'Chimera').sort(() => Math.random() - 0.5);

                const high = parseInt(localStorage.getItem('lexicon_high_score') || 0);
                if (type === 'outcast' && high < 8) {
                    initFloor();
                    showScreen('screen-game');
                    document.getElementById('tutorial-modal').style.display = 'flex';
                } else {
                    initFloor();
                    showScreen('screen-game');
                }
            };

            window.openTutorial = () => {
                AudioEngine.playShop();
                document.getElementById('tutorial-modal').style.display = 'flex';
            };

            window.closeTutorial = () => {
                document.getElementById('tutorial-modal').style.display = 'none';
                AudioEngine.playKey();
            };

            window.startEndless = () => { window.G.isEndless = true; document.getElementById('victory-modal').style.display = 'none'; openRespite(); };

            window.setDiff = (d, btn) => {
                if (btn.classList.contains('locked')) {
                    const msg = d === 'medium' ? "Reach Floor XX to unlock." : "Reach Floor XXI to unlock.";
                    toast(msg); return;
                }
                window.G.difficulty = d;
                document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateDifficultyInfo();
            };

            function updateDifficultyInfo() {
                const info = document.getElementById('diff-description');
                if (window.G.difficulty === 'easy') info.innerText = "Easy: 6 attempts. Common words. Slow scaling.";
                else if (window.G.difficulty === 'medium') info.innerText = "Medium: 5 attempts. Random dictionary. More Trials.";
                else info.innerText = "Hard: 5 attempts. Obscure words. Fast scaling (up to 12).";
            }

            function initFloor() {
                window.G.guesses = []; window.G.currentGuess = ""; window.G.keyStatus = {}; window.G.forbiddenLetters = new Set();
                window.G.hazardTiles = []; window.G.modifiers = []; window.G.bossActive = null; window.G.hints = {}; window.G.unknownCount = 0;
                window.G.corruptedKeys = []; window.G.timerSeconds = 180; window.G.taxedLetters = []; window.G.solveFlag = false;
                window.G.scrambledKeys = {}; window.G.wardActive = false; window.G.suppressedModifier = null; window.G.midFloor = true;
                
                if (window.G.archetype === 'tinker') {
                    window.G.maxHp -= (window.G.tinkerBonus || 0);
                    window.G.hp = Math.max(1, window.G.hp - (window.G.tinkerBonus || 0));
                    const itemCount = window.G.consumables.filter(c => c !== null).length;
                    window.G.tinkerBonus = itemCount * 10;
                    window.G.maxHp += window.G.tinkerBonus;
                    window.G.hp += window.G.tinkerBonus;
                }

                let len = Math.floor((window.G.floor - 1) / 4) + 4;
                len = Math.min(len, 8); 

                if (window.G.difficulty === 'hard') {
                    len = Math.min(Math.floor((window.G.floor - 1) / 2) + 4, 12);
                }
                
                let pool;
                if (window.G.difficulty === 'easy') {
                    pool = EASY_LEXICON[len] || CURATED_TARGETS[len] || CURATED_TARGETS[4];
                } else {
                    pool = FULL_LEXICON[len] || CURATED_TARGETS[len] || CURATED_TARGETS[4];
                }
                
                let list = Array.from(pool);
                window.G.targetWord = list[Math.floor(Math.random()*list.length)];
                
                const isHunter = window.G.archetype === 'hunter';
                const isEveryFourth = window.G.floor % 4 === 0;

                if (window.G.floor === 20 && !window.G.isEndless) triggerBoss("Chimera");
                else if (isHunter || isEveryFourth || (window.G.isEndless && window.G.floor % 2 === 0)) triggerBoss(window.G.isEndless ? "Chimera" : "");
                else if (window.G.floor >= 9 && Math.random() > 0.6) window.G.modifiers.push("Hazards");
                
                if(window.G.modifiers.includes("Hazards")) {
                    for(let i=0; i<2; i++) window.G.hazardTiles.push({r: Math.floor(Math.random()*window.G.maxGuesses), c: Math.floor(Math.random()*window.G.targetWord.length)});
                }

                if(window.G.archetype === 'prodigy') revealOne();
                if (window.G.upgrades.includes('compass')) {
                    const char = window.G.targetWord[Math.floor(Math.random()*window.G.targetWord.length)];
                    window.G.keyStatus[char] = 'present';
                }

                saveGame(); updateUI(); renderGrid(); renderKeyboard();
            }

            function triggerBoss(forced) {
                let b;
                const pool = BOSS_LIST.filter(x => x.mod !== 'Chimera');

                if (forced === "Chimera") {
                    let bossCount = 2;
                    if (window.G.isEndless) {
                        bossCount = 2 + Math.floor((window.G.floor - 20) / 20);
                        bossCount = Math.min(bossCount, 6);
                    }
                    const selection = [];
                    const tempPool = [...pool];
                    for(let i=0; i<bossCount; i++) selection.push(tempPool.splice(Math.floor(Math.random()*tempPool.length), 1)[0]);
                    
                    b = { name: "THE CHIMERA", desc: selection.map(s => s.name.split(" ").pop()).join(" & ") + " fused.", mods: selection.map(s => s.mod) };
                    window.G.modifiers.push(...b.mods);
                } else {
                    const bModKey = window.G.availableBosses.splice(0, 1)[0];
                    const meta = BOSS_LIST.find(x => x.mod === bModKey) || BOSS_LIST[0];
                    b = { name: meta.name, desc: meta.desc, mods: [meta.mod] };
                    window.G.modifiers.push(meta.mod);
                    if (window.G.availableBosses.length === 0) window.G.availableBosses = BOSS_LIST.map(b => b.mod).filter(m => m !== 'Chimera').sort(() => Math.random() - 0.5);
                }
                
                window.G.bossActive = b.name;
                if(window.G.modifiers.includes("Corrupt")) {
                    const keys = "abcdefghijklmnopqrstuvwxyz".split("");
                    for(let i=0; i<3; i++) window.G.corruptedKeys.push(keys.splice(Math.floor(Math.random()*keys.length), 1)[0]);
                }
                if(window.G.modifiers.includes("Tax")) {
                    const keys = "abcdefghijklmnopqrstuvwxyz".split("");
                    for(let i=0; i<3; i++) window.G.taxedLetters.push(keys.splice(Math.floor(Math.random()*keys.length), 1)[0]);
                }
                
                document.getElementById('boss-name').innerText = b.name;
                document.getElementById('boss-desc').innerText = b.desc;
                document.getElementById('boss-alert').style.display = 'block';
            }

            window.hideBossAlert = () => { document.getElementById('boss-alert').style.display = 'none'; updateUI(); };

            function renderGrid() {
                const grid = document.getElementById('grid'); 
                grid.innerHTML = ""; const container = document.getElementById('grid-container');
                if (!container.clientHeight) return;
                const colCount = window.G.targetWord.length; const rowCount = window.G.maxGuesses;
                const gapSize = colCount > 9 ? 2 : 4;
                grid.style.gap = gapSize + "px";
                
                const size = Math.min((container.clientHeight - 40) / rowCount, (container.clientWidth - 40) / colCount, 55); 
                grid.style.gridTemplateColumns = `repeat(${colCount}, ${size}px)`;
                grid.style.gridTemplateRows = `repeat(${rowCount}, ${size}px)`;
                
                const isPhantom = isEffectActive("Phantom");
                const isBlight = isEffectActive("Blight");
                const lastIdx = window.G.guesses.length - 1;
                
                for(let r=0; r<rowCount; r++) {
                    for(let c=0; c<colCount; c++) {
                        const tile = document.createElement('div'); tile.className = "tile";
                        tile.style.width = tile.style.height = size+"px"; 
                        tile.style.fontSize = (colCount > 9 ? size * 0.45 : size * 0.5) + "px";
                        
                        if(window.G.hazardTiles.some(h=>h.r===r && h.c===c)) tile.classList.add('hazard');
                        
                        if(window.G.guesses[r]) {
                            if(isBlight && window.G.guesses.length >= r + 2) {
                                tile.classList.add('hidden');
                            } else {
                                const char = window.G.guesses[r].word[c];
                                tile.innerText = char;
                                let s = window.G.guesses[r].status[c];
                                
                                // NEW PHANTOM LOGIC: Delay feedback by 1 turn
                                if (isPhantom && r === lastIdx) {
                                    s = 'absent';
                                }

                                if (isEffectActive("Illusionist") && s === 'correct') {
                                    if (window.G.guesses[r].word === window.G.targetWord) tile.classList.add('correct');
                                    else tile.classList.add('present');
                                }
                                else tile.classList.add(s);
                            }
                        } else if(r === window.G.guesses.length) {
                            if(window.G.currentGuess[c] && window.G.currentGuess[c] !== " ") tile.innerText = window.G.currentGuess[c];
                            else if(window.G.hints[c]) { tile.innerText = window.G.hints[c]; tile.style.opacity = "0.4"; }
                            
                            tile.onclick = () => {
                                AudioEngine.playKey();
                                let arr = window.G.currentGuess.split("");
                                while(arr.length < window.G.targetWord.length) arr.push(" ");
                                arr[c] = " ";
                                window.G.currentGuess = arr.join("").trimEnd();
                                renderGrid();
                            };
                            tile.style.cursor = "pointer";
                        }
                        grid.appendChild(tile);
                    }
                }
            }

            function renderKeyboard() {
                const isIllusionist = isEffectActive("Illusionist");
                
                kbLayout.forEach((row, idx) => {
                    const rowEl = document.getElementById(`kb-${idx+1}`); rowEl.innerHTML = "";
                    row.forEach(k => {
                        const btn = document.createElement('button'); btn.className = "key" + (k.length > 1 ? " large" : "");
                        const low = k.toLowerCase();
                        if (window.G.scrambledKeys[low]) btn.innerText = window.G.scrambledKeys[low];
                        else btn.innerText = k === "DEL" ? "‚å´" : k;
                        
                        let s = window.G.keyStatus[low];
                        if (s) {
                            if (isIllusionist && s === 'correct') s = 'present';
                            btn.classList.add(s);
                        }
                        if(window.G.forbiddenLetters.has(low)) btn.classList.add('absent');
                        if(window.G.corruptedKeys.includes(low) && isEffectActive("Corrupt")) btn.classList.add('corrupted');
                        if(window.G.taxedLetters.includes(low) && isEffectActive("Tax")) btn.classList.add('taxed');
                        
                        if (k === "DEL") {
                            btn.onmousedown = btn.ontouchstart = (e) => { e.preventDefault(); handleKey("DEL"); delRepeatInterval = setInterval(() => handleKey("DEL"), 150); };
                            btn.onmouseup = btn.ontouchend = btn.onmouseleave = () => clearInterval(delRepeatInterval);
                        } else btn.onclick = () => handleKey(k);
                        rowEl.appendChild(btn);
                    });
                });
            }

            function isEffectActive(mod) {
                if (window.G.wardActive && window.G.suppressedModifier === mod) return false;
                if (window.G.archetype === 'anchor' && (window.G.maxGuesses - window.G.guesses.length) <= 2) return false;
                return window.G.modifiers.includes(mod);
            }

            function handleKey(k) {
                if(window.G.isGameOver) return; AudioEngine.init(); AudioEngine.playKey();
                if(k === "‚èé") submitGuess();
                else if(k === "DEL") {
                    let arr = window.G.currentGuess.split("");
                    for(let i = arr.length - 1; i >= 0; i--) {
                        if(arr[i] !== " ") { 
                            const charToRemove = arr[i].toLowerCase();
                            if(isEffectActive("Tax") && window.G.taxedLetters.includes(charToRemove)) {
                                window.G.coins += 5; updateUI();
                            }
                            arr[i] = " "; break; 
                        }
                    }
                    window.G.currentGuess = arr.join("").trimEnd();
                }
                else if(window.G.currentGuess.length < window.G.targetWord.length || window.G.currentGuess.includes(" ")) {
                    const low = k.toLowerCase();
                    if(window.G.forbiddenLetters.has(low)) { toast("Consumed by Void"); return; }
                    
                    if(window.G.taxedLetters.includes(low) && isEffectActive("Tax")) {
                        if(window.G.difficulty !== 'easy' && window.G.coins < 5) { toast("No Coins"); return; }
                        window.G.coins -= 5; updateUI();
                    }
                    if(window.G.corruptedKeys.includes(low) && isEffectActive("Corrupt")) { takeDamage(3); toast("Corrupted!"); }
                    
                    if(/^[a-z]$/i.test(k)) {
                        let arr = window.G.currentGuess.split("");
                        while(arr.length < window.G.targetWord.length) arr.push(" ");
                        let insertIdx = arr.indexOf(" ");
                        if(insertIdx !== -1) arr[insertIdx] = low;
                        window.G.currentGuess = arr.join("").trimEnd();
                    }
                }
                renderGrid();
            }

            function submitGuess() {
                const gRaw = window.G.currentGuess;
                const g = gRaw.split("").map(c => c === " " ? "" : c).join("");
                if(g.length < window.G.targetWord.length) { toast("Incomplete"); return; }
                
                let isDict;
                if (window.G.difficulty === 'easy') {
                    isDict = EASY_LEXICON[g.length]?.has(g) || CURATED_TARGETS[g.length]?.includes(g);
                } else {
                    isDict = FULL_LEXICON[g.length]?.has(g) || CURATED_TARGETS[g.length]?.includes(g);
                }

                const isOutcast = window.G.archetype === 'outcast';
                const statusArr = [];
                const mimicLie = (isEffectActive("Glitch")) ? Math.floor(Math.random() * g.length) : -1;
                const forceTrue = window.G.upgrades.includes('clarity') ? Math.floor(Math.random() * g.length) : -1;
                let newGreens = 0; let absentCount = 0;

                if (!isDict && !isOutcast) {
                    if (window.G.archetype === 'cursed') {
                        toast("Cursed: Invalid Guess"); window.G.invalidWordBonus++;
                        for(let i=0; i<g.length; i++) statusArr.push('invalid'); AudioEngine.playWrong();
                    } else {
                        window.G.unknownCount++;
                        if (window.G.unknownCount < 5) { toast(`Obscure Word (${window.G.unknownCount}/5)`); AudioEngine.playWrong(); return; }
                        window.G.unknownCount = 0; for(let i=0; i<g.length; i++) statusArr.push('invalid'); AudioEngine.playWrong();
                    }
                } else {
                    window.G.unknownCount = 0; 
                    if(isEffectActive("Censor") && g !== window.G.targetWord) takeDamage(g.length);
                    for(let i=0; i<g.length; i++) {
                        let s = 'absent';
                        if(g[i] === window.G.targetWord[i]) { s = 'correct'; if(window.G.keyStatus[g[i]] !== 'correct') newGreens++; }
                        else if(window.G.targetWord.includes(g[i])) s = 'present';
                        
                        if (i === forceTrue) {}
                        else if (i === mimicLie && s === 'absent') s = (Math.random() > 0.5) ? 'correct' : 'present';
                        
                        statusArr.push(s);
                        if(s==='absent') absentCount++;
                        if(s==='correct' || !window.G.keyStatus[g[i]]) window.G.keyStatus[g[i]] = s;
                        if(s==='absent') window.G.forbiddenLetters.add(g[i]);
                        if(window.G.hazardTiles.some(h=>h.r===window.G.guesses.length && h.c===i) && g[i]!==window.G.targetWord[i]) takeDamage(12);
                    }
                }
                if(window.G.upgrades.includes('vamp') && newGreens > 0) heal(newGreens * 3);
                if(window.G.upgrades.includes('ledger')) { 
                    if (window.G.archetype === 'bloodstained') heal(absentCount);
                    else window.G.coins += absentCount;
                    updateUI(); 
                }
                
                if(isEffectActive("VoidScramble")) {
                    const symbols = ["‚Ä†", "‚Ä°", "¬ß", "¬∂", "‚àû", " ", "‚óå", "‚óô"];
                    let activeKeys = "abcdefghijklmnopqrstuvwxyz".split("").filter(l => !window.G.forbiddenLetters.has(l));
                    for(let i=0; i<2; i++) {
                        if(activeKeys.length) {
                            const pick = activeKeys.splice(Math.floor(Math.random()*activeKeys.length), 1)[0];
                            window.G.scrambledKeys[pick] = symbols[Math.floor(Math.random()*symbols.length)];
                        }
                    }
                }
                window.G.guesses.push({word: g, status: statusArr});
                window.G.currentGuess = ""; 
                
                if(g === window.G.targetWord) winFloor(); else if(window.G.guesses.length >= window.G.maxGuesses) loseFloor();
                saveGame(); renderGrid(); renderKeyboard(); updateUI();
            }

            function solveWord() { window.G.solveFlag = true; window.G.currentGuess = window.G.targetWord; submitGuess(); }
            function heal(amt) { 
                if (window.G.archetype === 'bloodstained') amt = Math.floor(amt * 0.5);
                window.G.hp = Math.min(window.G.maxHp, window.G.hp + amt); updateUI(); 
            }

            function revealOne() { 
                const available = [];
                for(let i=0; i<window.G.targetWord.length; i++) {
                    const isSolvedAtSlot = window.G.guesses.some(g => g.status[i] === 'correct');
                    if(!window.G.hints[i] && !isSolvedAtSlot) available.push(i);
                }
                if(available.length) {
                    const idx = available[Math.floor(Math.random()*available.length)];
                    const char = window.G.targetWord[idx];
                    window.G.hints[idx] = char;
                    window.G.keyStatus[char] = 'correct';
                    renderGrid(); renderKeyboard();
                }
            }

            function purgeKeys() {
                const candidates = "abcdefghijklmnopqrstuvwxyz".split("").filter(l => !window.G.targetWord.includes(l) && !window.G.forbiddenLetters.has(l));
                for(let i=0; i<5; i++) if(candidates.length) window.G.forbiddenLetters.add(candidates.splice(Math.floor(Math.random()*candidates.length), 1)[0]);
                renderKeyboard(); toast("Keys Purged");
            }

            function takeDamage(amt) {
                if (window.G.archetype === 'withered') amt *= 0.5;
                if(window.G.upgrades.includes('armor')) amt = Math.max(0, amt - 5);
                if (amt > 0) AudioEngine.playHurt();
                window.G.hp = Math.max(0, window.G.hp - amt); updateUI();
                document.getElementById('damage-overlay').classList.add('damage-flash');
                setTimeout(() => document.getElementById('damage-overlay').classList.remove('damage-flash'), 400);
                if(window.G.hp <= 0) {
                    if(window.G.hasPhoenix) {
                        window.G.hasPhoenix = false; window.G.upgrades = window.G.upgrades.filter(u => u !== 'feather');
                        window.G.hp = Math.floor(window.G.maxHp / 2); 
                        toast("REVIVED!"); updateUI();
                    } else endRun();
                }
            }

            function updateHighScores() {
                const currentFloor = window.G.floor;
                const highFloor = parseInt(localStorage.getItem('lexicon_high_score') || 0);
                if (currentFloor > highFloor) localStorage.setItem('lexicon_high_score', currentFloor);
                
                const currentScore = window.G.totalScore;
                const highScoreTotal = parseInt(localStorage.getItem('lexicon_high_score_total') || 0);
                if (currentScore > highScoreTotal) localStorage.setItem('lexicon_high_score_total', currentScore);

                const archPB = parseInt(localStorage.getItem(`lexicon_high_score_${window.G.archetype}`) || 0);
                if (currentFloor > archPB) localStorage.setItem(`lexicon_high_score_${window.G.archetype}`, currentFloor);
            }

            function calculateScore() {
                window.G.totalScore = window.G.floor * (window.G.targetWord.length + window.G.coins);
            }

            function winFloor() {
                stopTimer(); window.G.midFloor = false;
                AudioEngine.playCorrect();
                
                if (!window.G.solveFlag) {
                    let total = 30 + (window.G.targetWord.length-4)*10 + (window.G.maxGuesses - window.G.guesses.length) * 15;
                    if(window.G.upgrades.includes('midas')) total += 15;
                    if(window.G.bossActive) total += 20; 
                    if (window.G.archetype === 'bloodstained') { heal(Math.floor(total / 2)); toast(`Blood Harvest: +${Math.floor(total / 4)} VIT`); }
                    else if (window.G.archetype === 'cursed') {
                        const multiplier = 1 + (window.G.invalidWordBonus * 0.2);
                        window.G.coins += Math.floor(total * multiplier);
                    } else window.G.coins += Math.floor(total);
                }
                
                if (window.G.bossActive && window.G.archetype === 'slayer') {
                    window.G.maxHp += 10; window.G.hp += 10; toast("Slayer: +10 Max Vitality");
                }

                calculateScore(); updateHighScores();

                if(!window.G.isEndless && window.G.floor === 20) setTimeout(() => document.getElementById('victory-modal').style.display='flex', 1000);
                else openRespite();
            }

            function loseFloor() { 
                stopTimer(); toast(`The word was: ${window.G.targetWord.toUpperCase()}`);
                AudioEngine.playWrong();
                let dmg = 30; if (window.G.bossActive) dmg = 50;
                takeDamage(dmg); 
                if(window.G.hp > 0) {
                    if(window.G.bossActive === "THE CHIMERA") { toast("Re-trial..."); setTimeout(() => initFloor(), 1500); }
                    else { window.G.midFloor = false; openRespite(); }
                }
            }

            window.openRespite = () => {
                const lastWord = window.G.targetWord.toUpperCase();
                const box = document.getElementById('respite-archive-box');
                const label = document.getElementById('respite-label');
                const header = document.getElementById('respite-header');
                const subtext = document.getElementById('respite-subtext');

                const nextFloorNum = window.G.floor + 1;
                const isHunter = window.G.archetype === 'hunter';
                const isEveryFourth = nextFloorNum % 4 === 0;
                const isEndlessBoss = window.G.isEndless && nextFloorNum % 2 === 0;
                const isChimera = nextFloorNum === 20 && !window.G.isEndless;
                
                const nextIsBoss = isHunter || isEveryFourth || isEndlessBoss || isChimera;

                if (nextIsBoss) {
                    box.classList.add('boss-style');
                    // Body background remains standard per user request
                    document.body.classList.remove('boss-active'); 
                    
                    let bossName = "TRIAL ENCOUNTER";
                    if (isChimera) bossName = "THE CHIMERA";
                    else if (window.G.availableBosses.length > 0) {
                        const meta = BOSS_LIST.find(b => b.mod === window.G.availableBosses[0]);
                        if (meta) bossName = meta.name;
                    }
                    
                    label.innerText = `Floor ${romNums[nextFloorNum] || nextFloorNum} Trial`;
                    header.innerText = bossName;
                    subtext.innerText = `Last Archive: ${lastWord}`;
                } else {
                    box.classList.remove('boss-style');
                    document.body.classList.remove('boss-active');
                    let nextBoss;
                    if (window.G.isEndless) nextBoss = nextFloorNum + (1 - (nextFloorNum % 2));
                    else nextBoss = nextFloorNum + (3 - (nextFloorNum % 4));
                    
                    const diff = nextBoss - window.G.floor;
                    const progText = `${diff} floor${diff > 1 ? 's' : ''} to next Trial.`;
                    
                    label.innerText = "Last Archive";
                    header.innerText = lastWord;
                    subtext.innerText = progText;
                }
                
                showScreen('screen-respite');
                saveGame();
            };

            window.executeRest = () => {
                const lost = window.G.maxHp - window.G.hp;
                const amt = Math.floor(lost * 0.3);
                heal(amt);
                toast(`Restored ${amt} Vitality.`);
                nextFloor();
            };

            function enterShop() {
                saveGame(); window.G.floorPurchases = new Set();
                const pool = Object.keys(ITEMS).filter(k => !window.G.consumables.includes(k) && !(ITEMS[k].type==='perm' && window.G.upgrades.includes(k)));
                window.G.currentShopPool = pool.sort(() => 0.5-Math.random()).slice(0, 6);
                setTimeout(() => { showScreen('screen-shop'); renderShop(); updateUI(); }, 200);
            }
            window.enterShop = enterShop;

            function renderShop() {
                const cont = document.getElementById('shop-items'); cont.innerHTML = "";
                window.G.currentShopPool.forEach(k => {
                    const it = ITEMS[k];
                    let cost = it.cost; 
                    if(window.G.discountActive) cost = Math.floor(cost * 0.5);
                    if(window.G.archetype === 'merchant') cost = Math.floor(cost * 0.75);
                    const isSold = window.G.floorPurchases.has(k);
                    const div = document.createElement('div'); div.className = "shop-item" + (isSold ? " sold" : "");
                    let costStr = cost + ' Coins';
                    if (window.G.archetype === 'bloodstained') costStr = Math.ceil(cost / 2) + ' VIT';
                    div.innerHTML = `<div class="shop-tag">${it.type === 'cons' ? 'Item' : 'Relic'}</div><div><b>${it.emoji} ${it.name}</b><small>${it.desc}</small></div><button class="btn" style="width:100%; min-width:unset; font-size:0.7rem; padding:8px;" ${isSold ? 'disabled' : ''} onclick="buyItem('${k}')">${isSold ? 'Sold' : costStr}</button>`;
                    cont.appendChild(div);
                });
            }

            window.buyItem = (k) => {
                const it = ITEMS[k];
                let cost = it.cost; 
                if(window.G.discountActive) cost = Math.floor(cost * 0.5);
                if(window.G.archetype === 'merchant') cost = Math.floor(cost * 0.75);
                
                if (window.G.archetype === 'bloodstained') {
                    const hpCost = Math.ceil(cost / 2);
                    if (window.G.hp > hpCost) {
                        takeDamage(hpCost); AudioEngine.playShop();
                        if(it.type === 'cons') { 
                            const idx = window.G.consumables.indexOf(null); 
                            if(idx!==-1) window.G.consumables[idx]=k; 
                            else { toast("Bag Full!"); heal(hpCost); return; }
                        } else it.run();
                        window.G.floorPurchases.add(k); window.G.discountActive = false; 
                    } else toast("Vitality too low");
                } else {
                    if(window.G.coins >= cost) {
                        window.G.coins -= cost; AudioEngine.playShop();
                        if(it.type === 'cons') { 
                            const idx = window.G.consumables.indexOf(null); 
                            if(idx!==-1) window.G.consumables[idx]=k; 
                            else { toast("Bag Full!"); window.G.coins += cost; return; }
                        } else it.run();
                        window.G.floorPurchases.add(k); window.G.discountActive = false; 
                    } else toast("Not enough Coins");
                }
                calculateScore(); updateUI(); renderShop(); saveGame();
            };

            function updateUI() {
                const savedName = localStorage.getItem('lexicon_player_name') || "Stranger";
                const soulName = (archNames[window.G.archetype] || "Outcast").toUpperCase();
                
                document.getElementById('player-name-val').innerText = savedName;
                document.getElementById('soul-name-val').innerText = soulName;
                
                document.getElementById('floor-val-header').innerText = `Floor ${romNums[window.G.floor] || window.G.floor}`;
                document.getElementById('score-val').innerText = `${window.G.totalScore} Points`;
                
                document.getElementById('hp-val').innerText = `${Math.ceil(window.G.hp)} / ${window.G.maxHp}`;
                document.getElementById('hp-bar').style.width = (window.G.hp/window.G.maxHp*100)+"%";
                document.getElementById('coins-subval').innerText = window.G.coins;

                const modBar = document.getElementById('modifiers-bar'); modBar.innerHTML = "";
                const body = document.getElementById('game-body');
                const isGameScreen = document.getElementById('screen-game').classList.contains('active');

                if(window.G.bossActive && isGameScreen) { 
                    body.classList.add('boss-active');
                    const div = document.createElement('div'); div.className = "boss-info";
                    let desc = window.G.modifiers.map(m => {
                        let text = BOSS_DATA[m] || "";
                        if (m === "Clock") {
                            const min = Math.floor(window.G.timerSeconds / 60);
                            const sec = window.G.timerSeconds % 60;
                            text = `Time remaining: ${min}:${sec.toString().padStart(2, '0')}.`;
                        }
                        return text;
                    }).join(" ");
                    div.innerHTML = `<span class="boss-name-ui">${window.G.bossActive}</span><span class="boss-desc-ui">${desc}</span>`;
                    modBar.appendChild(div);
                } else if (!isGameScreen && !document.getElementById('screen-respite').classList.contains('active')) {
                    body.classList.remove('boss-active');
                }
                const rb = document.getElementById('active-relics'); rb.innerHTML = "";
                window.G.upgrades.forEach(u => { const s = document.createElement('span'); s.innerText = ITEMS[u].emoji; rb.appendChild(s); });
                renderInventory('inventory-game'); renderInventory('inventory-shop');
            }

            function renderInventory(id) {
                const cont = document.getElementById(id); if(!cont) return; cont.innerHTML = "";
                window.G.consumables.forEach((c, i) => {
                    const slot = document.createElement('div'); slot.className = "item-slot" + (c ? "" : " empty");
                    if(c) {
                        const it = ITEMS[c];
                        slot.innerText = it.emoji; slot.setAttribute('data-desc', it.desc);
                        slot.onclick = () => {
                            if(isEffectActive("Silence") && id === 'inventory-game') { toast("Silenced!"); return; }
                            if (c === 'masterkey' && window.G.bossActive === "THE CHIMERA") {
                                toast("The Key shatters vs the Chimera!");
                                window.G.consumables[i] = null; AudioEngine.playWrong(); updateUI(); return;
                            }
                            const mod = document.getElementById('confirm-modal');
                            document.getElementById('confirm-title').innerText = `Use ${it.name}?`;
                            document.getElementById('confirm-desc').innerText = it.desc;
                            mod.style.display = 'flex';
                            document.getElementById('confirm-yes').onclick = () => {
                                if (window.G.archetype === 'tinker') {
                                    window.G.maxHp -= 10; window.G.tinkerBonus -= 10; window.G.hp = Math.min(window.G.hp, window.G.maxHp);
                                }
                                it.run(); window.G.consumables[i] = null; AudioEngine.playShop(); calculateScore(); updateUI(); saveGame(); mod.style.display = 'none';
                            };
                        };
                    }
                    cont.appendChild(slot);
                });
            }

            function endRun() { 
                window.G.isGameOver = true; calculateScore(); updateHighScores();
                localStorage.removeItem('lexicon_run_save'); 
                const pName = localStorage.getItem('lexicon_player_name') || "Stranger";
                document.getElementById('game-summary').innerText = `${pName} reached Floor ${romNums[window.G.floor] || window.G.floor} as ${archNames[window.G.archetype] || 'The Outcast'}.`;
                document.getElementById('game-final-score').innerText = `Final Score: ${window.G.totalScore}`;
                document.getElementById('game-last-word').innerText = `Word: ${window.G.targetWord.toUpperCase()}`; 
                showScreen('screen-gameover'); 
            }
            function nextFloor() { window.G.floor++; initFloor(); showScreen('screen-game'); }
            window.nextFloor = nextFloor;

            window.goHome = () => { if (!window.G.isGameOver) saveGame(); showScreen('screen-start'); };
            window.executeSurrender = () => { document.getElementById('surrender-modal').style.display='none'; loseFloor(); };
            window.closeRules = () => { document.getElementById('rules-modal').style.display='none'; };
            function saveGame() { 
                if (window.G.hp <= 0 || window.G.isGameOver) { localStorage.removeItem('lexicon_run_save'); return; }
                const saveState = {...window.G, forbiddenLetters: Array.from(window.G.forbiddenLetters), floorPurchases: Array.from(window.G.floorPurchases)}; 
                localStorage.setItem('lexicon_run_save', JSON.stringify(saveState)); 
            }
            function toast(m) { const t=document.getElementById('toast'); t.innerHTML=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4000); }
            window.addEventListener('keydown', e => { if(document.getElementById('screen-game').classList.contains('active')) { if(e.key==="Enter") handleKey("‚èé"); else if(e.key==="Backspace") handleKey("DEL"); else if(/^[a-z]$/i.test(e.key)) handleKey(e.key.toUpperCase()); } });
            loadLexicon();
        })();
    </script>
</body>
</html>
