<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lexicon</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700&display=swap');

        :root {
            --bg-color: #d2b48c;
            --ink-black: #1c140d;
            --green: #2d5a27;
            --yellow: #a67c00;
            --gray: #4a443f;
            --hazard: #8b0000;
            --invalid-red: #5e0000;
            --accent: #5d3a1a;
            --text: #2c1e14;
            --font-main: 'Crimson Text', serif;
            --font-title: 'Cinzel', serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.15) 100%), url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            color: var(--text);
            font-family: var(--font-main);
            height: 100vh; height: 100dvh;
            width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        #damage-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; transition: box-shadow 0.1s;
        }

        @keyframes bloodPulse {
            0% { box-shadow: inset 0 0 0px rgba(139, 0, 0, 0); }
            10% { box-shadow: inset 0 0 150px rgba(139, 0, 0, 0.9); }
            100% { box-shadow: inset 0 0 0px rgba(139, 0, 0, 0); }
        }
        .damage-flash { animation: bloodPulse 0.4s ease-out forwards; }

        /* Centering Logic */
        .screen {
            display: none; flex-direction: column;
            width: 100%; height: 100%;
            max-width: 500px; padding: 20px;
            position: relative; justify-content: center; align-items: center;
            text-align: center;
        }
        .screen.active { display: flex; }

        .screen-content {
            width: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #main-header {
            display: none; width: 100%; max-width: 500px;
            grid-template-columns: 1fr 1.5fr 1fr; gap: 5px;
            padding: 8px 10px 12px 10px; background: #2c1e14;
            border: 3px solid #1c140d; margin-top: 10px;
            border-radius: 6px; color: #d2b48c; z-index: 100;
        }

        .header-panel {
            background: #b89f7a; border: 1px solid #1c140d;
            border-radius: 3px; padding: 4px; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            color: var(--ink-black); min-height: 60px;
        }

        .stat-value { font-family: var(--font-title); font-weight: bold; }
        .hp-bar-container { width: 100%; height: 6px; background: rgba(0,0,0,0.3); margin-top: 4px; }
        .hp-bar-fill { height: 100%; background: var(--hazard); transition: width 0.5s; }

        .ribbon-btn {
            position: absolute; bottom: -28px; width: 34px; height: 42px;
            background: #8b0000; color: #fff; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 50% 80%, 0% 100%);
        }

        /* Keyboard & Grid */
        #grid { display: grid; gap: 4px; margin: 10px 0; }
        .tile {
            border: 2px solid #8b7355; background: #fdf5e6;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: var(--font-title); text-transform: uppercase;
        }
        .tile.correct { background: var(--green); color: white; }
        .tile.present { background: var(--yellow); color: white; }
        .tile.absent { background: var(--gray); color: rgba(255,255,255,0.3); }

        .keyboard { display: flex; flex-direction: column; gap: 6px; width: 100%; padding-bottom: 20px; }
        .kb-row { display: flex; justify-content: center; gap: 4px; }
        .key {
            height: 52px; flex: 1; background: #3d2b1f; color: #d2b48c;
            border-radius: 6px; font-weight: bold; font-family: var(--font-title);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 #1a0f0a; border: none;
        }
        .key.large { flex: 1.5; }

        /* Shop */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .shop-item { background: #fdf5e6; padding: 10px; border: 1.5px solid #1c140d; display: flex; flex-direction: column; justify-content: space-between; text-align: left; }

        .btn { 
            background: #3d2b1f; color: #d2b48c; padding: 14px 20px; border: 3px double #d2b48c;
            font-family: var(--font-title); cursor: pointer; margin: 8px 0;
        }
        .archetype-card { background: #fdf5e6; padding: 12px; border: 2px solid var(--accent); margin-bottom: 10px; width: 100%; text-align: left; }
        .message-toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: #1c140d; color: #d2b48c; padding: 10px 20px; border-radius: 6px; opacity: 0; z-index: 9999; transition: 0.3s; font-family: var(--font-title); }
        .message-toast.show { opacity: 1; transform: translate(-50%, 20px); }

        .boss-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a0f0a; color: #d2b48c; padding: 25px; border: 4px double var(--hazard); width: 85%; z-index: 4000; text-align: center; display: none; }
    </style>
</head>
<body>

    <div id="damage-overlay"></div>

    <div id="main-header">
        <div class="ribbon-btn" style="left: 10px; background: #3d2b1f;" onclick="goHome()">‚åÇ</div>
        <div class="ribbon-btn" id="surrender-ribbon" style="right: 10px;">üè≥</div>
        <div class="header-panel"><div>Floor</div><div id="floor-val" class="stat-value">I</div></div>
        <div class="header-panel"><div>Vitality</div><div id="hp-val" class="stat-value">60/60</div><div class="hp-bar-container"><div id="hp-bar" class="hp-bar-fill"></div></div></div>
        <div class="header-panel"><div>Coins</div><div id="coins-val" class="stat-value">0</div></div>
    </div>

    <div id="screen-loading" class="screen active">
        <div class="screen-content">
            <h2 class="title" style="font-size: 3rem; letter-spacing: 6px;">LEXICON</h2>
            <p style="font-style: italic;">Loading the Archives...</p>
        </div>
    </div>

    <div id="screen-start" class="screen">
        <div class="screen-content">
            <h1 class="title" style="font-size: 4rem; letter-spacing: 8px;">LEXICON</h1>
            <p style="margin-bottom: 30px;">‚Äî A Rogue‚Äôs Descent ‚Äî</p>
            <button class="btn" onclick="showScreen('screen-archetype')">Enter the Abyss</button>
        </div>
    </div>

    <div id="screen-archetype" class="screen">
        <div class="screen-content">
            <h2 class="title" style="margin-bottom: 20px;">Select Soul</h2>
            <div class="archetype-card" onclick="startRun('outcast')"><h3>The Outcast (Easy)</h3><p>60 Vit. Reuse forgotten letters.</p></div>
            <div class="archetype-card" onclick="startRun('poet')"><h3>The Poet</h3><p>80 Vit. +1 Attempt per floor.</p></div>
            <div class="archetype-card" onclick="startRun('scholar')"><h3>The Scholar</h3><p>40 Vit. 1.5x Coins. Longer words.</p></div>
            <div class="archetype-card" onclick="startRun('cursed')"><h3>The Cursed</h3><p>110 Vit. Invalid words count as failure.</p></div>
        </div>
    </div>

    <div id="screen-game" class="screen" style="justify-content: flex-start;">
        <div id="modifiers-bar" style="color: var(--hazard); font-weight: bold; margin-top: 10px; height: 20px; font-family: var(--font-title); font-size: 0.8rem;"></div>
        <div id="grid-container" style="flex:1; width:100%; display:flex; align-items:center; justify-content:center;"><div id="grid"></div></div>
        <div class="consumables-bar" id="inventory-game"></div>
        <div class="keyboard" id="keyboard">
            <div class="kb-row" id="kb-1"></div>
            <div class="kb-row" id="kb-2"></div>
            <div class="kb-row" id="kb-3"></div>
        </div>
    </div>

    <div id="screen-shop" class="screen" style="justify-content: flex-start;">
        <h2 class="title" style="margin: 20px 0;">The Library</h2>
        <div id="shop-items" class="shop-grid"></div>
        <p style="margin-top: 20px; font-family: var(--font-title);">Backpack</p>
        <div class="consumables-bar" id="inventory-shop"></div>
    </div>

    <div id="screen-gameover" class="screen">
        <h1 class="title" style="color: var(--hazard); font-size: 3rem;">Consumed</h1>
        <p id="game-summary" style="margin: 20px 0;"></p>
        <button class="btn" onclick="showScreen('screen-archetype')">Reincarnate</button>
    </div>

    <div id="boss-alert" class="boss-alert">
        <h1 id="boss-name">BOSS</h1>
        <p id="boss-desc" style="margin: 20px 0;"></p>
        <button class="btn" onclick="hideBossAlert()">Accept Trial</button>
    </div>

    <div id="toast" class="message-toast"></div>

    <script>
        (function() {
            const kbLayout = ["qwertyuiop".split(""), "asdfghjkl".split(""), ["ENTER", ..."zxcvbnm".split(""), "DEL"]];
            let FULL_LEXICON = {};
            const CURATED_TARGETS = {
                4: ["book", "page", "font", "word", "ink", "read", "sign", "tale", "lore", "myth", "bard"],
                5: ["write", "story", "verse", "rhyme", "quill", "paper", "novel", "shelf", "study"]
            };

            const ITEMS = {
                'potion': { emoji: 'üß™', name: 'Health Potion', desc: 'Heal 15 Vit.', cost: 25, type: 'cons', run: () => heal(15) },
                'dust': { emoji: 'üëÅÔ∏è', name: 'Scryer Dust', desc: 'Reveal 1 Letter.', cost: 40, type: 'cons', run: () => revealOne() },
                'holy_water': { emoji: '‚ú®', name: 'Holy Water', desc: 'Purify hazards.', cost: 45, type: 'cons', run: () => { window.G.hazardTiles = []; renderGrid(); toast("Purified"); } },
                'midas': { emoji: 'ü™ô', name: 'Midas Touch', desc: '+15 Coins/win.', cost: 130, type: 'perm', run: () => { window.G.upgrades.push('midas'); } },
                'dict': { emoji: 'üìñ', name: 'Encyclopedia', desc: '+1 Guess.', cost: 180, type: 'perm', run: () => { window.G.maxGuesses++; window.G.upgrades.push('dict'); } }
            };

            function createInitialState() {
                return { hp: 60, maxHp: 60, coins: 50, floor: 1, targetWord: "", currentGuess: "", guesses: [], maxGuesses: 6, archetype: 'outcast', upgrades: [], consumables: [null, null, null], keyStatus: {}, forbiddenLetters: new Set(), hazardTiles: [], modifiers: [], bossActive: null, floorPurchases: new Set(), midFloor: false };
            }

            window.G = createInitialState();

            async function loadLexicon() {
                try {
                    const r = await fetch('https://raw.githubusercontent.com/benjamincrom/scrabble/refs/heads/master/scrabble/dictionary.json');
                    const data = await r.json();
                    data.forEach(w => { if(w.length>=4 && w.length<=8) { if(!FULL_LEXICON[w.length]) FULL_LEXICON[w.length] = new Set(); FULL_LEXICON[w.length].add(w.toLowerCase()); } });
                } catch(e) { FULL_LEXICON = null; }
                showScreen('screen-start');
            }

            function showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                const header = document.getElementById('main-header');
                header.style.display = (id === 'screen-game' || id === 'screen-shop') ? 'grid' : 'none';
                if(id === 'screen-game') {
                    const srb = document.getElementById('surrender-ribbon');
                    srb.innerText = 'üè≥'; srb.onclick = surrenderFloor; srb.style.background = '#8b0000';
                } else if(id === 'screen-shop') {
                    const srb = document.getElementById('surrender-ribbon');
                    srb.innerText = '‚ûî'; srb.onclick = nextFloor; srb.style.background = '#2d5a27';
                }
            }
            window.showScreen = showScreen;

            function startRun(type) {
                window.G = createInitialState(); window.G.archetype = type;
                if(type==='poet') { window.G.hp=window.G.maxHp=80; window.G.maxGuesses=7; }
                else if(type==='scholar') { window.G.hp=window.G.maxHp=40; }
                else if(type==='cursed') { window.G.hp=window.G.maxHp=110; }
                initFloor(); showScreen('screen-game');
            }
            window.startRun = startRun;

            function initFloor() {
                window.G.guesses = []; window.G.keyStatus = {}; window.G.forbiddenLetters = new Set(); window.G.midFloor = true; window.G.floorPurchases = new Set();
                const len = (window.G.archetype==='scholar'?5:4) + Math.floor(window.G.floor/5);
                const pool = (FULL_LEXICON && FULL_LEXICON[len]) ? Array.from(FULL_LEXICON[len]) : (CURATED_TARGETS[len] || CURATED_TARGETS[4]);
                window.G.targetWord = pool[Math.floor(Math.random()*pool.length)];
                updateUI(); renderGrid(); renderKeyboard();
            }

            function renderGrid() {
                const grid = document.getElementById('grid'); grid.innerHTML = "";
                const cols = window.G.targetWord.length; const rows = window.G.maxGuesses;
                const size = Math.min(350 / cols, 50);
                grid.style.gridTemplateColumns = `repeat(${cols}, ${size}px)`;
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        const tile = document.createElement('div'); tile.className = "tile";
                        tile.style.width = tile.style.height = size+"px";
                        if(window.G.guesses[r]) {
                            tile.innerText = window.G.guesses[r].word[c];
                            tile.classList.add(window.G.guesses[r].status[c]);
                        } else if(r === window.G.guesses.length) {
                            tile.innerText = window.G.currentGuess[c] || "";
                        }
                        grid.appendChild(tile);
                    }
                }
            }

            function renderKeyboard() {
                kbLayout.forEach((row, idx) => {
                    const rowEl = document.getElementById(`kb-${idx+1}`); rowEl.innerHTML = "";
                    row.forEach(k => {
                        const btn = document.createElement('button'); btn.className = "key" + (k.length > 1 ? " large" : "");
                        btn.innerText = k === "DEL" ? "‚å´" : k;
                        const status = window.G.keyStatus[k.toLowerCase()];
                        if(status) btn.classList.add(status);
                        btn.onclick = () => handleInput(k);
                        rowEl.appendChild(btn);
                    });
                });
            }

            function handleInput(k) {
                if(k === "ENTER") submitGuess();
                else if(k === "DEL") window.G.currentGuess = window.G.currentGuess.slice(0, -1);
                else if(window.G.currentGuess.length < window.G.targetWord.length) window.G.currentGuess += k.toLowerCase();
                renderGrid();
            }

            function submitGuess() {
                const g = window.G.currentGuess;
                if(g.length < window.G.targetWord.length) return;
                
                // Logic Fix: Ensure dictionary check works or defaults to curated list
                const valid = (FULL_LEXICON && FULL_LEXICON[g.length]?.has(g)) || 
                              (CURATED_TARGETS[g.length]?.includes(g)) || 
                              window.G.archetype !== 'cursed';

                if(!valid && window.G.archetype === 'cursed') { loseFloor(); return; }
                
                const statusArr = [];
                for(let i=0; i<g.length; i++) {
                    let s = 'absent';
                    if(g[i] === window.G.targetWord[i]) s = 'correct';
                    else if(window.G.targetWord.includes(g[i])) s = 'present';
                    statusArr.push(s);
                    window.G.keyStatus[g[i]] = s;
                }
                window.G.guesses.push({word: g, status: statusArr});
                window.G.currentGuess = "";
                if(g === window.G.targetWord) winFloor();
                else if(window.G.guesses.length >= window.G.maxGuesses) loseFloor();
                renderGrid(); renderKeyboard(); updateUI();
            }

            function winFloor() {
                window.G.coins += 50 + (window.G.maxGuesses - window.G.guesses.length) * 15;
                enterShop();
            }

            function loseFloor() { window.G.hp -= 35; if(window.G.hp <= 0) showScreen('screen-gameover'); else enterShop(); }

            function enterShop() {
                window.G.midFloor = false;
                const pool = Object.keys(ITEMS).filter(k => {
                    const it = ITEMS[k];
                    const inBag = window.G.consumables.includes(k);
                    const inRelics = window.G.upgrades.includes(k);
                    return !inBag && !inRelics;
                });
                window.G.currentShopPool = pool.sort(() => 0.5 - Math.random()).slice(0, 4);
                showScreen('screen-shop'); renderShop(); updateUI();
            }

            function renderShop() {
                const container = document.getElementById('shop-items'); container.innerHTML = "";
                window.G.currentShopPool.forEach(k => {
                    const it = ITEMS[k];
                    const div = document.createElement('div'); div.className = "shop-item";
                    div.innerHTML = `<b>${it.emoji} ${it.name}</b><small>${it.desc}</small>
                    <button class="btn" style="padding:5px; font-size:0.8rem;" onclick="buyItem('${k}')">${it.cost} Coins</button>`;
                    container.appendChild(div);
                });
            }

            function buyItem(k) {
                const it = ITEMS[k];
                if(window.G.coins >= it.cost) {
                    window.G.coins -= it.cost;
                    if(it.type === 'cons') {
                        const idx = window.G.consumables.indexOf(null);
                        if(idx !== -1) window.G.consumables[idx] = k;
                    } else it.run();
                    enterShop();
                }
            }
            window.buyItem = buyItem;

            function nextFloor() { window.G.floor++; initFloor(); showScreen('screen-game'); }
            window.nextFloor = nextFloor;

            function updateUI() {
                document.getElementById('floor-val').innerText = window.G.floor;
                document.getElementById('hp-val').innerText = `${Math.ceil(window.G.hp)}/${window.G.maxHp}`;
                document.getElementById('hp-bar').style.width = (window.G.hp / window.G.maxHp * 100) + "%";
                document.getElementById('coins-val').innerText = window.G.coins;
                renderInventory('inventory-game'); renderInventory('inventory-shop');
            }

            function renderInventory(id) {
                const cont = document.getElementById(id); if(!cont) return;
